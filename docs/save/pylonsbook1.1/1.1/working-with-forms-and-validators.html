<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 6: Working with Forms and Validators &mdash; Pylons Book v1.1 documentation</title>
    <link rel="stylesheet" href="_static/default.css" tppabs="http://pylonsbook.com/en/1.1/_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" tppabs="http://pylonsbook.com/en/1.1/_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js" tppabs="http://pylonsbook.com/en/1.1/_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js" tppabs="http://pylonsbook.com/en/1.1/_static/doctools.js"></script>
    <link rel="top" title="Pylons Book v1.1 documentation" href="index.html" />
    <link rel="next" title="Chapter 7: Introducing the Model and SQLAlchemy" href="introducing-the-model-and-sqlalchemy.html" />
    <link rel="prev" title="Chapter 5: Using View Templates" href="using-view-templates.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" tppabs="http://pylonsbook.com/en/1.1/genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="introducing-the-model-and-sqlalchemy.html" tppabs="http://pylonsbook.com/en/1.1/introducing-the-model-and-sqlalchemy.html" title="Chapter 7: Introducing the Model and SQLAlchemy"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="using-view-templates.html" tppabs="http://pylonsbook.com/en/1.1/using-view-templates.html" title="Chapter 5: Using View Templates"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html" tppabs="http://pylonsbook.com/en/1.1/index.html">Pylons Book v1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chapter-6-working-with-forms-and-validators">
<h1>Chapter 6: Working with Forms and Validators<a class="headerlink" href="#chapter-6-working-with-forms-and-validators" title="Permalink to this headline">Â¶</a></h1>
<p id="index-2993">Form handling is one of those areas that at first glance appears very simple but in real applications can quickly become rather complicated. There are generally two approaches to dealing with forms. The first is to code all your forms, validation, and logic manually to give you complete control over how your forms work. The alternative approach is to use a form framework where ready-made classes exist for each of the field types you might want to use. The form framework then automates the generation of HTML, the validation of data, and the display of error messages for you.</p>
<p>At first glance, it might appear that a form framework would save you a lot of time, but in reality, form frameworks are rarely flexible enough to deal with all the situations you might want to develop, and in the long run you can sometimes find yourself spending more time creating custom fields for your form framework than it would have taken if you had coded all your forms manually.</p>
<p id="index-2994">Because of this, Pylons encourages you to do a lot of the work of generating forms yourself, but it does provide four sets of tools to make form handling as painless as possible:</p>
<blockquote>
<ul class="simple">
<li>Form helpers to generate the HTML for common field types</li>
<li>Validators to validate form data and convert between HTML and Python representations of particular data types</li>
<li>HTML Fill to take an HTML form and automatically populate it with values and error messages for redisplaying the form data</li>
<li>The <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator to automate the process of validating a form and redisplaying it if it contains invalid data</li>
</ul>
</blockquote>
<p id="index-2995">These four tools can help make handling forms much simpler without in any way constraining your creativity as a developer. Pylons does support an alternative approach with a tool, called ToscaWidgets, although it wonâ€™t be covered in this chapter. ToscaWidgets is a full form framework developed from the original widgets code in TurboGears that automates every aspect of form handling. ToscaWidgets is still officially in prerelease, but if you are interested in its approach, you should visit <a class="reference external" href="javascript:if(confirm('http://toscawidgets.org/  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://toscawidgets.org/'" tppabs="http://toscawidgets.org/">http://toscawidgets.org</a> to find out more. The majority of developers prefer the flexibility of the approach youâ€™ll use in this chapter.</p>
<div class="section" id="the-basics">
<h2>The Basics<a class="headerlink" href="#the-basics" title="Permalink to this headline">Â¶</a></h2>
<p id="index-2996">When a user submits a form on a web site, the data is submitted to the URL specified in the <tt class="docutils literal"><span class="pre">action</span></tt> attribute of the <tt class="docutils literal"><span class="pre">&lt;form&gt;</span></tt> tag. The data can be submitted either via HTTP GET or POST as specified by the <tt class="docutils literal"><span class="pre">method</span></tt> attribute of the <tt class="docutils literal"><span class="pre">&lt;form&gt;</span></tt> tag. If your form doesnâ€™t specify an <tt class="docutils literal"><span class="pre">action</span></tt>, then itâ€™s submitted to the current URL, but generally youâ€™ll want to specify an <tt class="docutils literal"><span class="pre">action</span></tt> attribute.</p>
<p>This is a simple form coded in HTML and without any Pylons-specific features:</p>
<div class="highlight-python"><pre>&lt;form name="test" method="get" action="/formtest/submit"&gt;
Email Address: &lt;input type="text" name="email" /&gt;
               &lt;input type="submit" name="submit" value="Submit" /&gt;
&lt;/form&gt;</pre>
</div>
<p>If your form contains a file upload field such as <tt class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;file&quot;</span> <span class="pre">name=&quot;myfile&quot;</span> <span class="pre">/&gt;</span></tt>, you will also need to specify an <tt class="docutils literal"><span class="pre">enctype=&quot;multipart/form-data&quot;</span></tt> attribute, and you have to choose the <tt class="docutils literal"><span class="pre">post</span></tt> method.</p>
<p>Many people put the value of the <tt class="docutils literal"><span class="pre">method</span></tt> attribute in uppercase. If your HTML page uses XHTML, the <tt class="docutils literal"><span class="pre">method</span></tt> attribute value is supposed to be lowercase, which is why in this example it is specified as <tt class="docutils literal"><span class="pre">method=&quot;get&quot;</span></tt>, not <tt class="docutils literal"><span class="pre">method=&quot;GET&quot;</span></tt>, as many examples will show.</p>
<p>Later in the chapter, youâ€™ll see how you can improve this example by using the <tt class="docutils literal"><span class="pre">h.url_for()</span></tt> helper in the form action and by using Pylonsâ€™ field helpers to generate most of the HTML for the form automatically. First, though, letâ€™s create a new Pylons project to test this example as it stands:</p>
<div class="highlight-python"><pre>$ paster create --template=pylons FormDemo</pre>
</div>
<p>Accept the default options by pressing Enter to choose Mako as the template engine and no SQLAlchemy or Google App Engine support.</p>
<p id="index-2997">Once the project has been created, letâ€™s create a simple template in <tt class="docutils literal"><span class="pre">FormDemo/formdemo/templates/base.html</span></tt> to use as a basis for the examples in this chapter:</p>
<div class="highlight-python"><pre>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;FormDemo&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
${next.body()}
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>Create a new template called <tt class="docutils literal"><span class="pre">simpleform.html</span></tt> with the following content to test the example form:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base.html" /&gt;
&lt;h1&gt;Enter Your Email Address&lt;/h1&gt;

&lt;form name="test" method="get" action="/formtest/submit"&gt;
Email Address: &lt;input type="text" name="email" /&gt;
               &lt;input type="submit" name="submit" value="Submit" /&gt;
&lt;/form&gt;</pre>
</div>
<p id="index-2998">Youâ€™ll remember from the previous chapter that the <tt class="docutils literal"><span class="pre">&lt;%inherit&gt;</span></tt> tag allows the body of a template to be inserted into a parent template.</p>
<p id="index-2999">Now create a new controller called <tt class="docutils literal"><span class="pre">formtest</span></tt>:</p>
<div class="highlight-python"><pre>$ cd FormDemo
$ paster controller formtest</pre>
</div>
<p>Add two actions to the controller that look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/simpleform.html&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;Your email is: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Start the server:</p>
<div class="highlight-python"><pre>$ paster serve --reload development.ini</pre>
</div>
<p>Visit <a class="reference external" href="javascript:if(confirm('http://localhost:5000/formtest/form  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/formtest/form'" tppabs="http://localhost:5000/formtest/form">http://localhost:5000/formtest/form</a>, and you will see the form. In this case, the generated HTML looks like this:</p>
<div class="highlight-python"><pre>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;FormDemo&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;h1&gt;Enter Your Email Address&lt;/h1&gt;

&lt;form name="test" method="get" action="/formtest/submit"&gt;
Email Address: &lt;input type="text" name="email" /&gt;
               &lt;input type="submit" name="submit" value="Submit" /&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p>Try entering the e-mail address <tt class="docutils literal"><span class="pre">test&#64;example.com</span></tt> and clicking Submit. The URL should change to <a class="reference external" href="javascript:if(confirm('http://localhost:5000/formtest/submit?email=test%40example.com&submit=Submit  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/formtest/submit?email=test%40example.com&submit=Submit'" tppabs="http://localhost:5000/formtest/submit?email=test%40example.com&submit=Submit">http://localhost:5000/formtest/submit?email=test%40example.com&amp;submit=Submit</a>, and you should see the text <tt class="docutils literal"><span class="pre">Your</span> <span class="pre">email</span> <span class="pre">is:</span> <span class="pre">test&#64;example.com</span></tt>.</p>
<p id="index-3000">Pylons has parsed and decoded the query string and set up the <tt class="docutils literal"><span class="pre">request.params</span></tt> object you saw in Chapter 3. As youâ€™ll recall, this object behaves a bit like a dictionary where the keys are the names of the fields in the form, and their corresponding values are Unicode strings, with all the characters in the query string properly decoded ready for you to use. If you have two fields with the same name in the form, then using the dictionary interface will return the first string. You can get all the strings returned as a list by using the <tt class="docutils literal"><span class="pre">.getall()</span></tt> method. If you expect only one value and want to enforce this, you should use <tt class="docutils literal"><span class="pre">.getone()</span></tt>, which raises an error if more than one value with the same name is submitted. By default, if a field is submitted without a value, the dictionary interface returns an empty string. This means that using <tt class="docutils literal"><span class="pre">.get(key,</span> <span class="pre">default)</span></tt> on <tt class="docutils literal"><span class="pre">request.params</span></tt> will return a default only if the value was not present in the form.</p>
<div class="section" id="post-vs-get">
<h3>POST vs. GET<a class="headerlink" href="#post-vs-get" title="Permalink to this headline">Â¶</a></h3>
<p id="index-3001">Forms can be submitted using either GET or POST HTTP methods depending on the value you set for the <tt class="docutils literal"><span class="pre">method</span></tt> attribute of the <tt class="docutils literal"><span class="pre">&lt;form&gt;</span></tt> tag. The GET method results in the form data being sent to the server via the URL query string, and the POST method sends the data as part of the HTTP body. Figure 6-1 and Figure 6-2 show the LiveHTTPHeaders information for both types of requests.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0601.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0601.png"><img alt="Figure 6-1. A GET request in LiveHTTPHeaders" src="_images/9349f0601.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0601.png" /></a>
<p class="caption">Figure 6-1. A GET request in LiveHTTPHeaders</p>
</div>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0602.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0602.png"><img alt="Figure 6-2. A POST request in LiveHTTPHeaders" src="_images/9349f0602.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0602.png" /></a>
<p class="caption">Figure 6-2. A POST request in LiveHTTPHeaders</p>
</div>
<p id="index-3002">As you can see, the request method (in the first line of both figures) is different in each. Youâ€™ll also see that the POST request has the e-mail address sent as extra content in the body rather than as part of the URL. It is possible to send very large amounts of data in the request body, but most browsers and servers can cope only with URLs that are less than 1,024 characters in length. This is why if you are using a file upload field, you should use the POST method, because the data is then sent in the body of the request.</p>
<p id="index-3003">You can test the POST method by editing the <tt class="docutils literal"><span class="pre">simpleform.html</span></tt> template so that the method is changed to <tt class="docutils literal"><span class="pre">post</span></tt>. If you rerun the example, you will see the same message is displayed as before, but the URL displayed in the browser after you submit the form is simply <a class="reference external" href="javascript:if(confirm('http://localhost:5000/formtest/submit  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/formtest/submit'" tppabs="http://localhost:5000/formtest/submit">http://localhost:5000/formtest/submit</a> without the query string. If you are writing forms that contain password fields, you should usually use POST to prevent the password from being visible to anyone who might be looking at the userâ€™s screen. If you are ever in any doubt as to which method to use in a particular circumstance, it is normally safer to use POST.</p>
<p>Regardless of whether the form data is submitted as a GET or a POST request, Pylons still makes the values available in your controllers using the same interface through <tt class="docutils literal"><span class="pre">request.params</span></tt>.</p>
<p id="index-3004">You might be wondering how Pylons copes if you submit a form with a POST method to a URL containing a query string. The answer is that both sets of values get merged into the <tt class="docutils literal"><span class="pre">request.params</span></tt> object. Occasionally you might want to access the query string data separately from the POST data, so Pylons also provides two other <tt class="docutils literal"><span class="pre">MultiDict</span></tt> objects that behave in the same way as <tt class="docutils literal"><span class="pre">request.params</span></tt> to allow you to do just that. They are accessed as <tt class="docutils literal"><span class="pre">request.GET</span></tt> and <tt class="docutils literal"><span class="pre">request.POST</span></tt>, respectively.</p>
</div>
<div class="section" id="the-resubmitted-data-problem">
<h3>The Resubmitted Data Problem<a class="headerlink" href="#the-resubmitted-data-problem" title="Permalink to this headline">Â¶</a></h3>
<p id="index-3005">When writing form-based applications, you will occasionally find that users will press Refresh immediately after submitting a form. This has the effect of repeating whatever actions were performed the first time the form was submitted, but this might not always be the behavior your users expect.</p>
<p>If your form was submitted with a POST, most browsers will display a message to the user asking them whether they want to resubmit the data (see Figure 6-3). This will not happen with a GET, so POST is preferable to GET in those circumstances.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0603.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0603.png"><img alt="Figure 6-3. The dialog box displayed by Firefox when you click Refresh on a page where POST data has been submitted" src="_images/9349f0603.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0603.png" /></a>
<p class="caption">Figure 6-3. The dialog box displayed by Firefox when you click Refresh on a page where POST data has been submitted</p>
</div>
<p id="index-3006">Of course, the best way to solve this issue is to structure your code in such a way that if the user refreshes the page, the data isnâ€™t resubmitted. Hereâ€™s one way of achieving this with an HTTP redirect:</p>
<div class="highlight-python"><pre># in the controller

    def form(self):
        return render('/simpleform.html')

    def submit(self):
        # Code to perform some action based on the form data
        # ...
        h.redirect_to(controller='formtest', action='result')

    def result(self):
        return 'Your data was successfully submitted.'</pre>
</div>
<p>This code requires the use of the <tt class="docutils literal"><span class="pre">redirect_to()</span></tt> helper. Add the following import to the projectâ€™s <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">redirect_to</span>
</pre></div>
</div>
<p>Then in the controller, import the <tt class="docutils literal"><span class="pre">helpers</span></tt> module by adding this line at the top:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">formdemo.lib.helpers</span> <span class="kn">as</span> <span class="nn">h</span>
</pre></div>
</div>
<p>Now you can test the controller. In this case, once the form is submitted, the data is saved, and an HTTP redirect occurs so that the browser redirects to <a class="reference external" href="javascript:if(confirm('http://localhost:5000/formtest/result  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/formtest/result'" tppabs="http://localhost:5000/formtest/result">http://localhost:5000/formtest/result</a>. If the user then refreshes the page, it simply redisplays the message rather than reperforming the action.</p>
<p id="index-3007">One issue with this approach is that if you want to display some of the submitted data, you will need to load it again in the <tt class="docutils literal"><span class="pre">result()</span></tt> action because the request that calls that action doesnâ€™t contain any of the submitted data. In Chapter 8, Iâ€™ll cover how these sorts of messages can be displayed by storing information in a session store.</p>
</div>
</div>
<div class="section" id="building-forms-with-helpers">
<h2>Building Forms with Helpers<a class="headerlink" href="#building-forms-with-helpers" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3008">Forms can also be created with Pylonsâ€™ built-in helpers. Youâ€™ve already seen the helpers in Chapter 3 and learned about how they escape data to avoid security problems in Chapter 5; in this section, youâ€™ll learn how to use the HTML helpers to create forms.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last" id="index-3009">The WebHelpers package from which the Pylons helpers are imported changed significantly in version 0.6. All the old helpers from Rails were deprecated in favor of the new-style literal approach documented in Chapter 5. All the JavaScript integration with Prototype and Script.aculo.us was also removed because the majority of developers preferred to use their own JavaScript framework. Youâ€™ll learn more about Pylons integration with JavaScript frameworks in Chapter 15.</p>
</div>
<p>Letâ€™s update the form youâ€™ve been working on to use some of the HTML form helpers. Change the <tt class="docutils literal"><span class="pre">simpleform.html</span></tt> file to look like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base.html" /&gt;
&lt;h1&gt;Enter Your E-mail Address&lt;/h1&gt;

${h.form(h.url_for(controller='formtest', action='submit'), method='get')}
Email Address: ${h.text('email')}
               ${h.submit('submit', 'Submit')}
${h.end_form()}</pre>
</div>
<p id="index-3010">You can see that you are using the <tt class="docutils literal"><span class="pre">form()</span></tt>, <tt class="docutils literal"><span class="pre">url_for()</span></tt>, <tt class="docutils literal"><span class="pre">text()</span></tt>, and <tt class="docutils literal"><span class="pre">submit()</span></tt> helpers. The <tt class="docutils literal"><span class="pre">url_for()</span></tt> helper actually comes from Routes, but the other helpers come from the <tt class="docutils literal"><span class="pre">webhelpers.html.tags</span></tt> module. Youâ€™ll need to add all these helpers to your sample projectâ€™s <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> file too in order for this example to work:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">routes</span> <span class="kn">import</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">webhelpers.html.tags</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>The built-in form helpers simply generate fragments of HTML to help you build forms. There are no built-in checks to ensure that you have closed an open form tag, so it is up to you to ensure that you produce valid HTML. Of course, this is actually very useful because it gives you a lot of flexibility. For example, you are free to mix and match HTML and helpers in whichever way you see fit, or you could even define the start of a form in one template and the end of a form in another without the helpers getting in your way. The helpers do correctly escape any string or Unicode values you pass them, but they donâ€™t modify any values that have already been escaped with <tt class="docutils literal"><span class="pre">literal()</span></tt>.</p>
<p id="index-3011">It is worth becoming familiar with the form helpers available because using them can save a lot of time (particularly with more complex fields such as selects), and they will also ensure all your data is properly escaped. The HTML helpers are well documented at <a class="reference external" href="javascript:if(confirm('http://docs.pylonshq.com/thirdparty/webhelpers/html/html/  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://docs.pylonshq.com/thirdparty/webhelpers/html/html/#webhelpers-html-tags'" tppabs="http://docs.pylonshq.com/thirdparty/webhelpers/html/html/#webhelpers-html-tags">http://docs.pylonshq.com/thirdparty/webhelpers/html/html/#webhelpers-html-tags</a>, so you can always refer to the documentation for the details of how a particular helper works.</p>
<p id="index-3012">Letâ€™s take a look at the definition of the <tt class="docutils literal"><span class="pre">text()</span></tt> helper as an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">text</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
</pre></div>
</div>
<p>This creates a standard text field. <tt class="docutils literal"><span class="pre">value</span></tt> is a string, the content of the text field. The following are the options:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">disabled</span></tt></dt>
<dd>If set to <tt class="xref docutils literal"><span class="pre">True</span></tt>, the user will not be able to use this input.</dd>
<dt><tt class="docutils literal"><span class="pre">size</span></tt></dt>
<dd>This is the number of visible characters that will fit in the input.</dd>
<dt><tt class="docutils literal"><span class="pre">maxlength</span></tt></dt>
<dd>This is the maximum number of characters that the browser will allow the user to enter.</dd>
</dl>
<p>The remaining keyword options are standard HTML options for the tag.</p>
<p id="index-3013">All form helpers start with a <tt class="docutils literal"><span class="pre">name</span></tt> argument, which should be a string representing the name of the field, and they also have an <tt class="docutils literal"><span class="pre">**attrs</span></tt> argument. In Python, <tt class="docutils literal"><span class="pre">**</span></tt> is a notation that means that any extra keyword arguments passed to the function should be put in a dictionary called <tt class="docutils literal"><span class="pre">attrs</span></tt> where the keys are the parameter names and the values are their corresponding values.</p>
<p>Any extra parameters you pass to any of these helpers are treated as extra attributes to be added to the HTML tag generated. Hereâ€™s an example where you specify an attribute that isnâ€™t part of the HTML specification to an <tt class="docutils literal"><span class="pre">&lt;input&gt;</span></tt> field. Again, the helpers wonâ€™t flag this as an error; it is up to you to decide what is right for your application and be responsible for the attributes you set.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">h</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;Welcome&#39;</span><span class="p">,</span> <span class="n">myattribute</span><span class="o">=</span><span class="s">&#39;myvalue&#39;</span><span class="p">)</span>
<span class="go">&#39;&lt;input type=&quot;text&quot; value=&quot;Welcome&quot; myattribute=&quot;myvalue&quot; /&gt;&#39;</span>
</pre></div>
</div>
<p id="index-3014">One common use for this functionality is to specify the CSS class the field should have. The problem is that <tt class="docutils literal"><span class="pre">class</span></tt> is a reserved word in Python, so to specify the <tt class="docutils literal"><span class="pre">class</span></tt> attribute, you need to pass in the parameter <tt class="docutils literal"><span class="pre">class_</span></tt> with a trailing <tt class="docutils literal"><span class="pre">_</span></tt> character.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">h</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;Welcome&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&#39;wide&#39;</span><span class="p">)</span>
<span class="go">&#39;&lt;input type=&quot;text&quot; value=&quot;Welcome&quot; class=&quot;wide&quot; /&gt;&#39;</span>
</pre></div>
</div>
<p id="index-3015">The <tt class="docutils literal"><span class="pre">text()</span></tt> helper has a special behavior for the attributes <tt class="docutils literal"><span class="pre">disabled</span></tt>, <tt class="docutils literal"><span class="pre">size</span></tt>, and <tt class="docutils literal"><span class="pre">maxlength</span></tt>. All the single value field helpers behave in a similar way. They are <tt class="docutils literal"><span class="pre">checkbox()</span></tt>, <tt class="docutils literal"><span class="pre">file()</span></tt>, <tt class="docutils literal"><span class="pre">hidden()</span></tt>, <tt class="docutils literal"><span class="pre">image()</span></tt>, <tt class="docutils literal"><span class="pre">password()</span></tt>, <tt class="docutils literal"><span class="pre">radio()</span></tt>, <tt class="docutils literal"><span class="pre">submit()</span></tt>, and <tt class="docutils literal"><span class="pre">textarea()</span></tt>.</p>
<p id="index-3016">There is also a <tt class="docutils literal"><span class="pre">select()</span></tt> helper, and it behaves slightly differently. If you look at the documentation for <tt class="docutils literal"><span class="pre">select()</span></tt>, youâ€™ll see it is defined like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">selected_values</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead of taking a <tt class="docutils literal"><span class="pre">value</span></tt> argument, it has a <tt class="docutils literal"><span class="pre">selected_values</span></tt> argument and an <tt class="docutils literal"><span class="pre">options</span></tt> argument:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">selected_values</span></tt></dt>
<dd>A string or list of strings or integers giving the value(s) that should be preselected.</dd>
<dt><tt class="docutils literal"><span class="pre">options</span></tt></dt>
<dd><p class="first">An iterable of <tt class="docutils literal"><span class="pre">(value,</span> <span class="pre">label)</span></tt> pairs. The value is what is returned to the application if this option is chosen; the label is what is shown in the form. You can also pass an iterable of strings, in which case the labels will be identical to the values.</p>
<p>If you are used to the <tt class="docutils literal"><span class="pre">select()</span></tt> helper from an earlier version of WebHelpers, you might expect to be able to use <tt class="docutils literal"><span class="pre">options_for_select()</span></tt>. This has been deprecated and is not available in Pylons 0.9.7. Instead, you just pass in the list of tuples directly via <tt class="docutils literal"><span class="pre">options</span></tt>. Youâ€™ll also notice that the order of items in the tuple is reversed. <tt class="docutils literal"><span class="pre">options_for_select()</span></tt> expects arguments in the form <tt class="docutils literal"><span class="pre">(label,</span> <span class="pre">value)</span></tt>, but this isnâ€™t how most Python objects are generated.</p>
<p id="index-3017">The following shows <tt class="docutils literal"><span class="pre">select()</span></tt> in action:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">select</span><span class="p">(</span><span class="s">&quot;currency&quot;</span><span class="p">,</span> <span class="s">&quot;$&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="s">&quot;$&quot;</span><span class="p">,</span> <span class="s">&quot;Dollar&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;DKK&quot;</span><span class="p">,</span> <span class="s">&quot;Kroner&quot;</span><span class="p">]])</span>
<span class="go">literal(u&#39;&lt;select name=&quot;currency&quot;&gt;\n&lt;option selected=&quot;selected&quot; value=&quot;$&quot;&gt;Dollar&lt;/option&gt;\n&lt;option value=&quot;DKK&quot;&gt;Kroner&lt;/option&gt;\n&lt;/select&gt;&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">select</span><span class="p">(</span><span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;MasterCard&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="s">&quot;VISA&quot;</span><span class="p">,</span> <span class="s">&quot;MasterCard&quot;</span> <span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
<span class="go">literal(u&#39;&lt;select class=&quot;blue&quot; id=&quot;cc&quot; name=&quot;cc&quot;&gt;\n&lt;option value=&quot;VISA&quot;&gt;VISA&lt;/option&gt;\n&lt;option selected=&quot;selected&quot; value=&quot;MasterCard&quot;&gt;MasterCard&lt;/option&gt;\n&lt;/select&gt;&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">select</span><span class="p">(</span><span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;VISA&quot;</span><span class="p">,</span> <span class="s">&quot;Discover&quot;</span><span class="p">],</span> <span class="p">[</span> <span class="s">&quot;VISA&quot;</span><span class="p">,</span> <span class="s">&quot;MasterCard&quot;</span><span class="p">,</span> <span class="s">&quot;Discover&quot;</span> <span class="p">])</span>
<span class="go">literal(u&#39;&lt;select name=&quot;cc&quot;&gt;\n&lt;option selected=&quot;selected&quot; value=&quot;VISA&quot;&gt;VISA&lt;/option&gt;\n&lt;option value=&quot;MasterCard&quot;&gt;MasterCard&lt;/option&gt;\n&lt;option selected=&quot;selected&quot; value=&quot;Discover&quot;&gt;Discover&lt;/option&gt;\n&lt;/select&gt;&#39;)</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="uploading-files">
<h2>Uploading Files<a class="headerlink" href="#uploading-files" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3018">File upload fields are created by using the <tt class="docutils literal"><span class="pre">file</span></tt> input field type. The <tt class="docutils literal"><span class="pre">file()</span></tt> helper provides a shortcut for creating these form fields:</p>
<div class="highlight-python"><pre>${h.file('myfile')}</pre>
</div>
<p>To use the file field, you need to import it into the projectâ€™s <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">webhelpers.html.tags</span> <span class="kn">import</span> <span class="nb">file</span>
</pre></div>
</div>
<p>The HTML form must have its <tt class="docutils literal"><span class="pre">enctype</span></tt> attribute set to <tt class="docutils literal"><span class="pre">multipart/form-data</span></tt> to enable the browser to upload the file. The <tt class="docutils literal"><span class="pre">form()</span></tt> helperâ€™s <tt class="docutils literal"><span class="pre">multipart</span></tt> keyword argument provides a shortcut for setting the appropriate <tt class="docutils literal"><span class="pre">enctype</span></tt> value. You donâ€™t need to explicitly mark the form to use a POST because the helper automatically sets the <tt class="docutils literal"><span class="pre">method</span></tt> attribute to <tt class="docutils literal"><span class="pre">post</span></tt> when you specify the <tt class="docutils literal"><span class="pre">enctype</span></tt> for a file upload.</p>
<p>Letâ€™s add a new controller to the form named <tt class="docutils literal"><span class="pre">upload</span></tt>:</p>
<div class="highlight-python"><pre>$ paster controller upload</pre>
</div>
<p>Change the <tt class="docutils literal"><span class="pre">index()</span></tt> action so it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/uploadform.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Then add this new template to the <tt class="docutils literal"><span class="pre">templates</span></tt> directory as <tt class="docutils literal"><span class="pre">uploadform.html</span></tt>:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base.html" /&gt;
&lt;h1&gt;Upload a File&lt;/h1&gt;


${h.form(h.url_for(controller='upload', action='upload'), multipart=True)}
Upload file:      ${h.file('myfile')} &lt;br /&gt;
Description:      ${h.text('description')} &lt;br /&gt;
                  ${h.submit('submit', 'Submit')}
${h.end_form()}</pre>
</div>
<p>If you visit <a class="reference external" href="javascript:if(confirm('http://localhost:5000/upload/index  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/upload/index'" tppabs="http://localhost:5000/upload/index">http://localhost:5000/upload/index</a>, you should see the form.</p>
<p id="index-3019">Now letâ€™s think about how to handle the upload. When a file upload has succeeded, the <tt class="docutils literal"><span class="pre">request.POST</span></tt> (or <tt class="docutils literal"><span class="pre">request.params</span></tt>) <tt class="docutils literal"><span class="pre">MultiDict</span></tt> will contain a <tt class="docutils literal"><span class="pre">cgi.FieldStorage</span></tt> object as the value of the field.</p>
<p><tt class="docutils literal"><span class="pre">FieldStorage</span></tt> objects have three important attributes for file uploads:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">filename</span></tt></dt>
<dd>This is the name of the file uploaded as it appeared on the uploaderâ€™s filesystem.</dd>
<dt><tt class="docutils literal"><span class="pre">file</span></tt></dt>
<dd><p class="first">This is a Python <tt class="docutils literal"><span class="pre">tempfile</span></tt> object from which the file can be read. For example:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;myfile&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt><tt class="docutils literal"><span class="pre">value</span></tt></dt>
<dd>This is the content of the uploaded file, eagerly read directly from the file object.</dd>
</dl>
<p>The easiest way to gain access to the fileâ€™s data is via the <tt class="docutils literal"><span class="pre">value</span></tt> attribute, which returns the entire contents of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">myfile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;myfile&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="s">&quot;Successfully uploaded: </span><span class="si">%s</span><span class="s">, size: </span><span class="si">%i</span><span class="s">, description: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">myfile</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">myfile</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
        <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>However, reading the entire contents of the file into memory is undesirable, especially for large file uploads. A common means of handling file uploads is to store the file somewhere on the filesystem. The <tt class="docutils literal"><span class="pre">FieldStorage</span></tt> instance already reads the file onto the filesystem; however, itâ€™s to a nonpermanent location, via a Python <tt class="docutils literal"><span class="pre">tempfile</span></tt> object.</p>
<p id="index-3020">Hereâ€™s an example that uses <tt class="docutils literal"><span class="pre">shutil.copyfileobj()</span></tt> to perform an efficient copy of the temp fileâ€™s data to a permanent location specified by the <tt class="docutils literal"><span class="pre">permanent_store</span></tt> variable in the config file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">myfile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;myfile&#39;</span><span class="p">]</span>
    <span class="n">permanent_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="s">&#39;app_conf&#39;</span><span class="p">][</span><span class="s">&#39;permanent_store&#39;</span><span class="p">],</span>
            <span class="n">myfile</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s">&#39;wb&#39;</span>
    <span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">myfile</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">permanent_file</span><span class="p">)</span>
    <span class="n">myfile</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">permanent_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="s">&#39;Successfully uploaded: </span><span class="si">%s</span><span class="s">, description: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">myfile</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>For this example to work, youâ€™ll need to add some imports at the top of the file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">import</span> <span class="nn">shutil</span>
</pre></div>
</div>
<p>Youâ€™ll also need to edit the <tt class="docutils literal"><span class="pre">development.ini</span></tt> config file and add this to the end of the <tt class="docutils literal"><span class="pre">[app:main]</span></tt> section:</p>
<div class="highlight-python"><pre>permanent_store = %(here)s/data/uploads</pre>
</div>
<p id="index-3021">Youâ€™ll remember from the discussion of config files in Chapter 3 that <tt class="docutils literal"><span class="pre">%(here)s</span></tt> is replaced with the location of the config file, so this example would upload files to the projectâ€™s <tt class="docutils literal"><span class="pre">data</span></tt> directory used as a cache for templates and sessions. Youâ€™ll need to create the <tt class="docutils literal"><span class="pre">uploads</span></tt> directory within the <tt class="docutils literal"><span class="pre">data</span></tt> directory because it wonâ€™t exist yet.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p id="index-3022">This basic example allows any file uploaded to overwrite any file in the <tt class="docutils literal"><span class="pre">permanent_store</span></tt> directory to which your web application has permissions.</p>
<p class="last">Also note the use of <tt class="docutils literal"><span class="pre">myfile.filename.replace(os.sep,</span> <span class="pre">'_')</span></tt> to ensure that the file name doesnâ€™t start with a <tt class="docutils literal"><span class="pre">/</span></tt> character. This is a simple security measure to help prevent specially crafted file names resulting in other files on your system being overwritten. You should always be suspicious of all data coming from a userâ€™s web browser and take appropriate steps to try to ensure that the data is safe.</p>
</div>
<p>Now that you can handle files being uploaded to the server, you might also want to provide a way for your users to download those files again.</p>
<p>First youâ€™ll need to import the <tt class="docutils literal"><span class="pre">mimetypes</span></tt> module to guess the content type of the file, so you should add the following import to the top of your controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">mimetypes</span> <span class="kn">import</span> <span class="n">guess_type</span>
</pre></div>
</div>
<p>You can then provide the download with an action like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">requested_filename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;requested_filename&#39;</span><span class="p">]</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s">&#39;app_conf&#39;</span><span class="p">][</span><span class="s">&#39;permanent_store&#39;</span><span class="p">],</span>
        <span class="n">requested_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;No such file&#39;</span>
    <span class="n">permanent_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">permanent_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">permanent_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">guess_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;text/plain&#39;</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p id="index-3023">You can test this by uploading a text file called <tt class="docutils literal"><span class="pre">somefile</span></tt> and then visiting the URL <a class="reference external" href="javascript:if(confirm('http://localhost:5000/upload/download?requested_filename=somefile  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/upload/download?requested_filename=somefile'" tppabs="http://localhost:5000/upload/download?requested_filename=somefile">http://localhost:5000/upload/download?requested_filename=somefile</a>. The example so far will correctly send the file to the browser, but the browser will try to display it if it is a type it recognizes such as a JPEG or a PNG file. If you want to force the browser to download the file as an attachment, you can add another HTTP header to the response like this just before you return the data:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;attachment; filename=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="o">%</span><span class="p">(</span>
     <span class="n">requested_filename</span>
 <span class="p">)</span>
</pre></div>
</div>
<p id="index-3024">This time the browser will treat the file as an attachment and prompt the user to ask how the file should be handled (see Figure 6-4).</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0604.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0604.png"><img alt="Figure 6-4. The Firefox attachment download dialog box" src="_images/9349f0604.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0604.png" /></a>
<p class="caption">Figure 6-4. The Firefox attachment download dialog box</p>
</div>
<p>Notice how in this example because the name given for the file name in the <tt class="docutils literal"><span class="pre">Content-Disposition</span></tt> HTTP header was <tt class="docutils literal"><span class="pre">somefile</span></tt>, the browser automatically tried to name the file <tt class="docutils literal"><span class="pre">somefile</span></tt> on the userâ€™s computer.</p>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p id="index-3025">Internet Explorer 6 has trouble downloading certain files as attachments over sites using a secure connection (see <a class="reference external" href="javascript:if(confirm('http://support.microsoft.com/default.aspx?scid=kb;en-us;812935  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://support.microsoft.com/default.aspx?scid=kb;en-us;812935'" tppabs="http://support.microsoft.com/default.aspx?scid=kb;en-us;812935">http://support.microsoft.com/default.aspx?scid=kb;en-us;812935</a>).</p>
<p>If you are writing a secure application that will be accessed by users with Internet Explorer, you should also add the following headers to the response to correct the problem:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Pragma&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="s">&#39;public&#39;</span>
<span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;max-age=0&#39;</span>
</pre></div>
</div>
<p class="last">Note that this an issue with Internet Explorer 6, not with Pylons!</p>
</div>
</div>
<div class="section" id="handling-forms-manually">
<h2>Handling Forms Manually<a class="headerlink" href="#handling-forms-manually" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3026">In the initial example in this chapter, I described how to create a simple form that enables a user to enter their e-mail address and to redisplay the value that was entered in a Pylons application. In most situations, it is important to be able to validate the information the user has entered. If you were asking for an e-mail address with an intention to use it to contact someone, it is important the e-mail address is a real address, so you would want to run some basic checks to ensure the e-mail wasnâ€™t obviously entered incorrectly. For example, the e-mail address should contain two strings separated by an <tt class="docutils literal"><span class="pre">&#64;</span></tt> character, and the domain name portion should contain a <tt class="docutils literal"><span class="pre">.</span></tt> character that should be followed by at least two characters representing the top-level domain. There are even more checks you could make, including ensuring the domain portion of the e-mail was a real domain name, but this probably isnâ€™t necessary for most situations.</p>
<p>If a user did enter an invalid e-mail, you would need to redisplay the form together with the e-mail address entered and an error message explaining what was wrong so that the user could correct their mistake. Letâ€™s create a controller to demonstrate this process manually. Later in the chapter, youâ€™ll learn how the Pylons tools make this process a lot simpler.</p>
<p>Letâ€™s update the <tt class="docutils literal"><span class="pre">formtest</span></tt> controller from earlier in the chapter to demonstrate this. Update the <tt class="docutils literal"><span class="pre">submit()</span></tt> action to look like this, and remove the <tt class="docutils literal"><span class="pre">result()</span></tt> action:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">email_msg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">email_value</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">email_msg</span> <span class="o">=</span> <span class="s">&quot;Please enter a value&quot;</span>
    <span class="k">elif</span> <span class="s">&#39;@&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">email_msg</span> <span class="o">=</span> <span class="s">&quot;An email address must contain at least one &#39;@&#39; character.&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">email_msg</span> <span class="o">=</span> <span class="s">&quot;An email address domain must contain &quot;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">email_msg</span> <span class="o">+=</span> <span class="s">&quot;at least one &#39;.&#39; character.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">domain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">email_msg</span> <span class="o">=</span> <span class="s">&quot;Please specify a domain type after the &#39;.&#39; character&quot;</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">email_msg</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">email_value</span> <span class="o">=</span> <span class="n">email</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/simpleform.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;Your email is: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p id="index-3027">Update the <tt class="docutils literal"><span class="pre">simpleform.html</span></tt> template to look like this:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base.html" /&gt;
&lt;h1&gt;Enter Your E-mail Address&lt;/h1&gt;

${h.form(h.url_for(controller='formtest', action='submit'), method='get')}
% if c.email_msg:
    &lt;span class="error-message"&gt;${c.email_msg}&lt;/span&gt;&lt;br /&gt;
% endif
E-mail Address: ${h.text('email', value=c.email_value)}
                ${h.submit('submit', 'Submit')}
${h.end_form()}</pre>
</div>
<p>Youâ€™ve used the Pylonsâ€™ helpers to generate the fields in this example; remember, you are free to use the helpers or to code your own HTML.</p>
<p>If you visit <a class="reference external" href="javascript:if(confirm('http://localhost:5000/formtest/form  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/formtest/form'" tppabs="http://localhost:5000/formtest/form">http://localhost:5000/formtest/form</a>, you will see that it achieves the desired result. If a user enters an invalid e-mail address, it will result in the form being redisplayed to show the error with the incorrect value still present in the text field ready to be corrected.</p>
<p id="index-3028">To make the error show up better, it would be sensible to add some Cascading Style Sheets (CSS) so that the error appears in red. The <tt class="docutils literal"><span class="pre">&lt;head&gt;</span></tt> of the page is defined in the <tt class="docutils literal"><span class="pre">base.html</span></tt> template, so you better add the CSS there.</p>
<p>Edit <tt class="docutils literal"><span class="pre">base.html</span></tt> so that you include the following line in the <tt class="docutils literal"><span class="pre">&lt;head&gt;</span></tt> section:</p>
<div class="highlight-python"><pre>&lt;link rel="stylesheet" type="text/css"
    href="${h.url_for('/style/style.css')}" /&gt;</pre>
</div>
<p>Then create a <tt class="docutils literal"><span class="pre">style</span></tt> directory in your projectâ€™s <tt class="docutils literal"><span class="pre">public</span></tt> directory, and create a file called <tt class="docutils literal"><span class="pre">style.css</span></tt> with the following content:</p>
<div class="highlight-python"><pre>span.error-message {
    font-weight: bold;
    color: #f00;
}</pre>
</div>
<p>You should find that all the error messages now appear in red, which will make the error much more obvious to your users (see Figure 6-5).</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0605.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0605.png"><img alt="Figure 6-5. The error message highlighted in red" src="_images/9349f0605.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0605.png" /></a>
<p class="caption">Figure 6-5. The error message highlighted in red</p>
</div>
<p id="index-3029">Although the approach youâ€™ve used here to manually validate the form works perfectly well, it would quickly become very complex if you were to also write code to handle many other types of fields in the same way. Luckily, Pylons comes with tools to make the processes you have just used much simpler.</p>
</div>
<div class="section" id="introducing-formencode">
<h2>Introducing FormEncode<a class="headerlink" href="#introducing-formencode" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3030">The recommended tool for validating forms in Pylons is FormEncode. FormEncode has two parts:</p>
<blockquote>
<ul class="simple">
<li>A set of <em>validators</em> used together to create <em>schemas</em>, which convert form data back and forth between Python objects and their corresponding form values</li>
<li>A tool called HTML Fill that takes an HTML form and parses it for form fields, filling in values and error messages as it goes from Python objects</li>
</ul>
</blockquote>
<p id="index-3031">Pylons provides a <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator, which can make the process of validating form data and redisplaying the form if necessary very easy, but in order to really understand what is going on during the validation process, Iâ€™ll first explain the process in full.</p>
<p id="index-3032">For each form you create, you also create a validation schema. Here is the validation schema for the form youâ€™ve been using so far. The example also includes a date field so I can later demonstrate how you can use schemas to convert data from one type to another as well as just validate input.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">formencode</span>

<span class="k">class</span> <span class="nc">EmailForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">DateConverter</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-3033">Although the form now has three fieldsâ€”an e-mail text field, a date validator, and a submit buttonâ€”you are interested only in validating the e-mail address and the date. If extra fields are submitted, FormEncodeâ€™s default behavior is to consider the form invalid, so you specify <tt class="docutils literal"><span class="pre">allow_extra_fields</span> <span class="pre">=</span> <span class="pre">True</span></tt> so that the value of the submit button is not validated. Since you donâ€™t want to use the value of the submit button, you also specify <tt class="docutils literal"><span class="pre">filter_extra_fields</span> <span class="pre">=</span> <span class="pre">True</span></tt> so that the value is ignored completely.</p>
<p id="index-3034">The third line specifies that the e-mail field should be validated with an <tt class="docutils literal"><span class="pre">Email()</span></tt> validator. In creating the validator, you also specify <tt class="docutils literal"><span class="pre">not_empty=True</span></tt> so that the e-mail field will require input. The final line specifies your date field and also that this particular date field should not be empty either.</p>
<p>Table 6-1 outlines the options that can be used in a schema in addition to the validators themselves.</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="4%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Attribute Name</th>
<th class="head">Default Value</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">pre_validators</span></tt></td>
<td><tt class="docutils literal"><span class="pre">[]</span></tt></td>
<td>These validators will be applied before the schema.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">chained_validators</span></tt></td>
<td><tt class="docutils literal"><span class="pre">[]</span></tt></td>
<td>These validators will be applied after the schema.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">allow_extra_fields</span></tt></td>
<td><tt class="xref docutils literal"><span class="pre">False</span></tt></td>
<td>If <tt class="xref docutils literal"><span class="pre">True</span></tt>, then it is not an error when keys that arenâ€™t associated with a validator are present.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">filter_extra_fields</span></tt></td>
<td><tt class="xref docutils literal"><span class="pre">False</span></tt></td>
<td>If <tt class="xref docutils literal"><span class="pre">True</span></tt>, then keys that arenâ€™t associated with a validator are removed.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">if_key_missing</span></tt></td>
<td><tt class="docutils literal"><span class="pre">NoDefault</span></tt></td>
<td>If this is given, then any keys that arenâ€™t available but are expected will be replaced with this value (and then validated). This does not override a present <tt class="docutils literal"><span class="pre">.if_missing</span></tt> attribute on validators. <tt class="docutils literal"><span class="pre">NoDefault</span></tt> is a special FormEncode class to mean that no default values have been specified and therefore missing keys shouldnâ€™t take a default value.</td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">ignore_key_missing</span></tt></td>
<td><tt class="xref docutils literal"><span class="pre">False</span></tt></td>
<td>If <tt class="xref docutils literal"><span class="pre">True</span></tt>, then missing keys will be missing in the result, if the validator doesnâ€™t have <tt class="docutils literal"><span class="pre">.if_missing</span></tt> on it already.</td>
</tr>
</tbody>
</table>
<p>Table 6-1. Additional Options That Can Be Used in a FormEncode Schema</p>
<p id="index-3035">It is usually best to keep form schemas together so that you have a single place you can go to update them. Itâ€™s also convenient for inheritance since you can make new form schemas that build on existing ones. If you put your forms in a <tt class="docutils literal"><span class="pre">model/form.py</span></tt> file, you can easily use them throughout your controllers. However, if you are creating a schema that is going to be used in only one controller, it is often more convenient to keep the schema with the controller. This is what youâ€™ll do here. Add the <tt class="docutils literal"><span class="pre">EmailForm</span></tt> schema to the top of the controller.</p>
<p>Now that you have added the schema, you need to be able to use it in your controller to validate the submitted form data that comes in via <tt class="docutils literal"><span class="pre">request.params</span></tt> and to convert the validated values from the format in which they are submitted to Python objects that can be used in the controller.</p>
<p id="index-3036">This is very straightforward because each <tt class="docutils literal"><span class="pre">Schema</span></tt> base class (and therefore the <tt class="docutils literal"><span class="pre">EmailForm</span></tt> class) has a <tt class="docutils literal"><span class="pre">to_python()</span></tt> method to handle the validation and conversion. If any of the validators fail to be able to convert the data, they raise a special exception type called a <tt class="docutils literal"><span class="pre">formencode.Invalid</span></tt> exception, which contains information about why the validation and conversion failed. Letâ€™s see it in practice. Be sure youâ€™ve added the <tt class="docutils literal"><span class="pre">EmailForm</span></tt> schema and <tt class="docutils literal"><span class="pre">import</span> <span class="pre">formencode</span></tt> line to the top of the controller file, and then update the <tt class="docutils literal"><span class="pre">submit()</span></tt> action to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">EmailForm</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">form_result</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;text/plain&#39;</span>
        <span class="k">return</span> <span class="s">&#39;Invalid: &#39;</span><span class="o">+</span><span class="nb">unicode</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;Your email is: </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">form_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Youâ€™ll also need to update the <tt class="docutils literal"><span class="pre">simpleform.html</span></tt> template to add the date field:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base.html" /&gt;
&lt;h1&gt;Enter Your E-mail Address&lt;/h1&gt;

${h.form(h.url_for(controller='formtest', action='submit'), method='get')}
&lt;p&gt;E-mail Address: ${h.text('email')}&lt;/p&gt;
&lt;p&gt;Date:           ${h.text('date')}&lt;/p&gt;
&lt;p&gt;                ${h.submit('submit', 'Submit')}&lt;/p&gt;
${h.end_form()}</pre>
</div>
<p>This new template is much simpler, but youâ€™ll notice that it doesnâ€™t contain any logic for setting the value of the e-mail field or displaying an error message. This will be handled separately using HTML Fill, which Iâ€™ll discuss later in the chapter.</p>
<p id="index-3037">If the values entered in the form are valid, the schemaâ€™s <tt class="docutils literal"><span class="pre">to_python()</span></tt> method returns a dictionary of the validated and coerced data, in this case assigned to <tt class="docutils literal"><span class="pre">form_result</span></tt>. This means you can guarantee that the <tt class="docutils literal"><span class="pre">form_result</span></tt> dictionary contains values that are valid and correct Python objects for the data types desired.</p>
<p>In this case, the e-mail address is a string, so <tt class="docutils literal"><span class="pre">request.params['email']</span></tt> happens to be the same as <tt class="docutils literal"><span class="pre">form_result['email']</span></tt>, but for the date field, <tt class="docutils literal"><span class="pre">request.params['date']</span></tt> is a string in the form <tt class="docutils literal"><span class="pre">&quot;mm/dd/yyyy&quot;</span></tt>, whereas <tt class="docutils literal"><span class="pre">form_result['date']</span></tt> is a Python <tt class="docutils literal"><span class="pre">datetime.date</span></tt> object representing the date the user entered. For even more complex data types, this ability of FormEncode to coerce data becomes very valuable.</p>
<p id="index-3038">Try entering some dates and e-mail addresses, both valid and invalid, and see the error messages FormEncode produces. As an example, if you entered the e-mail address <tt class="docutils literal"><span class="pre">james.example.com</span></tt> and the date <tt class="docutils literal"><span class="pre">01/40/2008</span></tt>, you would get the following errors:</p>
<div class="highlight-python"><pre>Invalid: date: That month only has 31 days
email: An email address must contain a single @</pre>
</div>
<p>Now try entering some valid data such as <tt class="docutils literal"><span class="pre">james&#64;example.com</span></tt> and <tt class="docutils literal"><span class="pre">01/15/2006</span></tt> and change the end of the <tt class="docutils literal"><span class="pre">submit()</span></tt> action to look like this:</p>
<div class="highlight-python"><pre>...
else:
    raise Exception(form_result)
    return 'Your email is: %s'%form_result.get('email')</pre>
</div>
<p>From the exception that occurs, you can see that <tt class="docutils literal"><span class="pre">form_result</span></tt> actually contains the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2006</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">u&#39;james@example.com&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p id="index-3039">As you can see, FormEncode has done more than simply validate the data; it has also converted it to the appropriate Python type so that you can easily work with it. The <tt class="docutils literal"><span class="pre">DateConverter</span></tt> validator has converted the text entered in the form into a Python <tt class="docutils literal"><span class="pre">date</span></tt> object, and the <tt class="docutils literal"><span class="pre">Email</span></tt> validator has returned a Unicode string. This is useful if you want to convert Python objects from your database to display in a table as part of your web application, for example. It is also used by HTML Fill to automatically repopulate form data if your form contains errors.</p>
<p id="index-3040">Here are some of the most frequently used FormEncode validators. For the full list, see the Available Validators documentation on the FormEncode web site:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">MaxLength</span></tt></dt>
<dd>The submitted value is invalid if it is longer than the <tt class="docutils literal"><span class="pre">maxLength</span></tt> argument. It uses <tt class="docutils literal"><span class="pre">len()</span></tt>, so it can work for strings, lists, or anything with length.</dd>
<dt><tt class="docutils literal"><span class="pre">MinLength</span></tt></dt>
<dd>The submitted value is invalid if it is shorter than the <tt class="docutils literal"><span class="pre">minLength</span></tt> argument. It uses <tt class="docutils literal"><span class="pre">len()</span></tt>, so it can work for strings, lists, or anything with length.</dd>
<dt><tt class="docutils literal"><span class="pre">Regex</span></tt></dt>
<dd>The submitted value is invalid if it doesnâ€™t match the regular expression <tt class="docutils literal"><span class="pre">regex</span></tt>. This is useful for matching phone numbers or postal codes, for example.</dd>
<dt><tt class="docutils literal"><span class="pre">PlainText</span></tt></dt>
<dd>This validator ensures that the field contains only letters, numbers, underscores, and hyphens. It subclasses <tt class="docutils literal"><span class="pre">Regex</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">DateConverter</span></tt></dt>
<dd>This validates and converts a date represented as a string, such as mm/yy, dd/mm/yy, dd-mm-yy, and so on. By using the <tt class="docutils literal"><span class="pre">month_style</span></tt> argument you can support mm/dd/yyyy or dd/mm/yyyy. Only these two general styles are supported.</dd>
<dt><tt class="docutils literal"><span class="pre">TimeConverter</span></tt></dt>
<dd>This converts times in the format HH:MM:SSampm to (h, m, s). Seconds are optional.</dd>
<dt><tt class="docutils literal"><span class="pre">StringBool</span></tt></dt>
<dd>This converts a string such as <tt class="docutils literal"><span class="pre">&quot;true&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&quot;0&quot;</span></tt> to a boolean.</dd>
<dt><tt class="docutils literal"><span class="pre">Int</span></tt></dt>
<dd>This converts a value to an integer.</dd>
<dt><tt class="docutils literal"><span class="pre">Number</span></tt></dt>
<dd>This converts a value to a float or integer. It tries to convert it to an integer if no information is lost.</dd>
<dt><tt class="docutils literal"><span class="pre">String</span></tt></dt>
<dd>This converts things to string but treats empty things as the empty string.</dd>
<dt><tt class="docutils literal"><span class="pre">UnicodeString</span></tt></dt>
<dd>This converts things to Unicode strings. This is a specialization of the <tt class="docutils literal"><span class="pre">String</span></tt> class.</dd>
<dt><tt class="docutils literal"><span class="pre">URL</span></tt></dt>
<dd>This validates a URL, either <tt class="docutils literal"><span class="pre">http://</span></tt> or <tt class="docutils literal"><span class="pre">https://</span></tt>. If <tt class="docutils literal"><span class="pre">check_exists</span></tt> is <tt class="xref docutils literal"><span class="pre">True</span></tt>, then youâ€™ll actually make a request for the page.</dd>
</dl>
<dl class="docutils" id="index-3041">
<dt><tt class="docutils literal"><span class="pre">Email</span></tt></dt>
<dd>This validates an e-mail address with the facility to check that the domain entered actually exists.</dd>
<dt><tt class="docutils literal"><span class="pre">OneOf</span></tt></dt>
<dd>This tests that the value is one of the members of a given list. This is particularly useful when validating an option from a select field because you can use it to check that the value submitted was one of the original values.</dd>
<dt><tt class="docutils literal"><span class="pre">FieldsMatch</span></tt></dt>
<dd>This tests that the given fields match, that is, are identical. It is useful for password+confirmation fields. Pass the list of field names in as <tt class="docutils literal"><span class="pre">field_names</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">ForEach</span></tt></dt>
<dd>Use this to apply a validator/converter to each item in a list.</dd>
<dt><tt class="docutils literal"><span class="pre">All</span></tt></dt>
<dd>This class is like an <tt class="docutils literal"><span class="pre">and</span></tt> operator for validators. All validators must work, and the results are passed in turn through all validators for conversion.</dd>
<dt><tt class="docutils literal"><span class="pre">Any</span></tt></dt>
<dd>This class is like an <tt class="docutils literal"><span class="pre">or</span></tt> operator for validators. The first validator/converter that validates the value will be used.</dd>
</dl>
<p id="index-3042">It can sometimes be difficult to work out the arguments that each validator will accept. The best way to find out is to look at the example usage for each type of validator on the FormEncode site. In addition to these arguments, validators also accept common arguments to configure their error messages and behavior. Youâ€™ll learn about these next.</p>
<div class="section" id="configuring-validators">
<h3>Configuring Validators<a class="headerlink" href="#configuring-validators" title="Permalink to this headline">Â¶</a></h3>
<p id="index-3043">Each of the validators will have a number of messages as well as a number of configuration options. Here are some examples of the sorts of messages available; these are for the <tt class="docutils literal"><span class="pre">ConfirmType</span></tt> validator:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">badType</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">&quot;The</span> <span class="pre">input</span> <span class="pre">must</span> <span class="pre">be</span> <span class="pre">a</span> <span class="pre">string</span> <span class="pre">(not</span> <span class="pre">a</span> <span class="pre">%(type)s:</span> <span class="pre">%(value)r)&quot;</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">empty</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">&quot;Please</span> <span class="pre">enter</span> <span class="pre">a</span> <span class="pre">value&quot;</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">inSubclass</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">&quot;%(object)r</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">a</span> <span class="pre">subclass</span> <span class="pre">of</span> <span class="pre">one</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">types</span> <span class="pre">%(subclassList)s&quot;</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">inType</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">&quot;%(object)r</span> <span class="pre">must</span> <span class="pre">be</span> <span class="pre">one</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">types</span> <span class="pre">%(typeList)s&quot;</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">noneType</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">&quot;The</span> <span class="pre">input</span> <span class="pre">must</span> <span class="pre">be</span> <span class="pre">a</span> <span class="pre">string</span> <span class="pre">(not</span> <span class="pre">None)&quot;</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">subclass</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">&quot;%(object)r</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">a</span> <span class="pre">subclass</span> <span class="pre">of</span> <span class="pre">%(subclass)s&quot;</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">type</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">&quot;%(object)r</span> <span class="pre">must</span> <span class="pre">be</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">type</span> <span class="pre">%(type)s&quot;</span></tt></dd>
</dl>
<p>To override the default value for an error message, you pass a <tt class="docutils literal"><span class="pre">messages</span></tt> argument to the validatorâ€™s constuctor. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;empty&#39;</span><span class="p">:</span><span class="s">&#39;Please enter a name&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>In each of these examples, constructs such as <tt class="docutils literal"><span class="pre">%(object)r</span></tt> and <tt class="docutils literal"><span class="pre">%(type)s</span></tt> are standard Python string-formatting terms. They are replaced by a string representation of the value to which they are referring. Terms ending in <tt class="docutils literal"><span class="pre">s</span></tt> result in the object being converted to a string with <tt class="docutils literal"><span class="pre">str()</span></tt>, and terms ending in <tt class="docutils literal"><span class="pre">r</span></tt> result in the objects being converted to a string with the <tt class="docutils literal"><span class="pre">repr()</span></tt> function that displays a Python representation of the value. You can use these same terms in your own custom messages if you like.</p>
<p>You donâ€™t need to specify messages for every error; FormEncode will use its defaults for any you donâ€™t specify. Messages often take arguments, such as the number of characters, the invalid portion of the field, and so on. These are always substituted as a dictionary (by name). So, you will use placeholders like <tt class="docutils literal"><span class="pre">%(key)s</span></tt> for each substitution. This way you can reorder or even ignore placeholders in your new message.</p>
<p id="index-3044">Later youâ€™ll see how to create your own validator. When you are creating a validator, for maximum flexibility you should use the <tt class="docutils literal"><span class="pre">message</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;key&#39;</span><span class="p">:</span> <span class="s">&#39;my message (with a </span><span class="si">%(substitution)s</span><span class="s">)&#39;</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">validate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">Invalid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="n">substitution</span><span class="o">=</span><span class="s">&#39;apples&#39;</span><span class="p">),</span>
                  <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-3045">Most validators support the following options (including your own validators, if you subclass from <tt class="docutils literal"><span class="pre">FancyValidator</span></tt>):</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">if_empty</span></tt></dt>
<dd>If set, then this value will be returned if the input evaluates to <tt class="xref docutils literal"><span class="pre">False</span></tt> (an empty list, empty string, <tt class="xref docutils literal"><span class="pre">None</span></tt>, and so on), but not a 0 or <tt class="xref docutils literal"><span class="pre">False</span></tt> objects. This applies only to <tt class="docutils literal"><span class="pre">.to_python()</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">not_empty</span></tt></dt>
<dd>If <tt class="xref docutils literal"><span class="pre">True</span></tt>, then if an empty value is given, this raises an error (both with <tt class="docutils literal"><span class="pre">.to_python()</span></tt> and also <tt class="docutils literal"><span class="pre">.from_python()</span></tt> if <tt class="docutils literal"><span class="pre">.validate_python</span></tt> is <tt class="xref docutils literal"><span class="pre">True</span></tt>).</dd>
<dt><tt class="docutils literal"><span class="pre">strip</span></tt></dt>
<dd>If <tt class="xref docutils literal"><span class="pre">True</span></tt> and the input is a string, strip it (occurs before empty tests).</dd>
<dt><tt class="docutils literal"><span class="pre">if_invalid</span></tt></dt>
<dd>If set, then this validator will raise <tt class="docutils literal"><span class="pre">Invalid</span></tt> during <tt class="docutils literal"><span class="pre">.to_python()</span></tt>; instead, return this value.</dd>
<dt><tt class="docutils literal"><span class="pre">if_invalid_python</span></tt></dt>
<dd>If set, when the Python value (converted with <tt class="docutils literal"><span class="pre">.from_python()</span></tt>) is invalid, this value will be returned.</dd>
<dt><tt class="docutils literal"><span class="pre">accept_python</span></tt></dt>
<dd>If <tt class="xref docutils literal"><span class="pre">True</span></tt> (the default), then <tt class="docutils literal"><span class="pre">.validate_python()</span></tt> and <tt class="docutils literal"><span class="pre">.validate_other()</span></tt> will not be called when <tt class="docutils literal"><span class="pre">.from_python()</span></tt> is used.</dd>
</dl>
<p id="index-3046">The values of the configuration options are stored as class attributes. As an example, look at the <tt class="docutils literal"><span class="pre">DateConverter</span></tt> you used earlier. It is documented at <a class="reference external" href="javascript:if(confirm('http://formencode.org/class-formencode.validators.DateConverter.html  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://formencode.org/class-formencode.validators.DateConverter.html'" tppabs="http://formencode.org/class-formencode.validators.DateConverter.html">http://formencode.org/class-formencode.validators.DateConverter.html</a>, where you can see that the class has a number of attributes including <tt class="docutils literal"><span class="pre">month_style</span></tt>, which defaults to mm/dd/yyyy. There are two ways to set these attributes. The first is to pass the name of the attribute as an argument to the validatorâ€™s constructor when you create it. Youâ€™ve already seen an example of this technique when you passed <tt class="docutils literal"><span class="pre">not_empty=True</span></tt> to the <tt class="docutils literal"><span class="pre">DateConverter</span></tt> and <tt class="docutils literal"><span class="pre">EmailValidator</span></tt> validators in your schema.</p>
<p id="index-3047">The other way to configure a validator is by using inheritance. You can create a new validator derived from the old one but with different default values for the attributes. As an example, here is a <tt class="docutils literal"><span class="pre">UKDateConverter</span></tt>, which uses the U.K. format for the date by default:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UKDateConverter</span><span class="p">(</span><span class="n">DateConverter</span><span class="p">):</span>
    <span class="n">month_style</span> <span class="o">=</span> <span class="s">&#39;dd/mm/yyyy&#39;</span>
</pre></div>
</div>
<p>You could then update your schema to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EmailForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">UKDateConverter</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-3048">Youâ€™ll learn more about creating your own validators later in this chapter.</p>
</div>
</div>
<div class="section" id="using-html-fill">
<h2>Using HTML Fill<a class="headerlink" href="#using-html-fill" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3049">Now that you have learned how to use FormEncode to validate and coerce data, you will still need to display error messages along with a repopulated form should the user have entered any invalid data.</p>
<p>This is from the HTML Fill documentation:</p>
<blockquote>
<tt class="docutils literal"><span class="pre">htmlfill</span></tt> <em>is a library to fill out forms, both with default values and error messages. Itâ€™s like a template library, but more limited, and it can be used with the output from other templates. It has no prerequesites and can be used without any other parts of FormEncode.</em></blockquote>
<p>The basic usage looks something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">htmlfill</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">form</span> <span class="o">=</span> <span class="s">&#39;&lt;input type=&quot;text&quot; name=&quot;fname&quot;&gt;&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;fname&#39;</span><span class="p">:</span> <span class="s">&#39;Joe&#39;</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">htmlfill</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
<span class="go">&#39;&lt;input type=&quot;text&quot; name=&quot;fname&quot; value=&quot;Joe&quot;&gt;&#39;</span>
</pre></div>
</div>
<p>The parser looks for HTML input elements (including <tt class="docutils literal"><span class="pre">select</span></tt> and <tt class="docutils literal"><span class="pre">textarea</span></tt>) and fills in the defaults. HTML Fill is therefore very useful in processing forms because you can return the form to the user with the values they entered, in addition to errors.</p>
<p id="index-3050">Letâ€™s update the controller to use HTML Fill. Change the <tt class="docutils literal"><span class="pre">submit()</span></tt> action to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">EmailForm</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">form_result</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">form_result</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">value</span>
        <span class="n">c</span><span class="o">.</span><span class="n">form_errors</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">error_dict</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/simpleform.html&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">htmlfill</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">html</span><span class="p">,</span>
            <span class="n">defaults</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">form_result</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">form_errors</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;Your email is: </span><span class="si">%s</span><span class="s"> and the date selected was </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">],</span>
            <span class="n">c</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">],</span>
        <span class="p">)</span>
</pre></div>
</div>
<p id="index-3051">Youâ€™ll also need to import HTML Fill. Add this import to the top of the controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">htmlfill</span>
</pre></div>
</div>
<p>In this example, when an error occurs, you use Pylonsâ€™ <tt class="docutils literal"><span class="pre">render()</span></tt> function to render the HTML of the original form as it was before the user submitted it. You then pass the HTML, as well as the form result values and the error messages dictionary, into HTML Fillâ€™s <tt class="docutils literal"><span class="pre">render()</span></tt> method. HTML Fill then parses the HTML, adding any error messages and field values for you automatically. The filled HTML is then returned so that the user can correct the errors as before.</p>
<p>Notice that you donâ€™t need the template code for the error messages and that none of the fields have values specified directly. HTML Fill populates the fields with the correct values and inserts any error messages automatically.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Being able to use plain HTML in this manner is actually very useful because it means any designers working on your project are able to use visual tools such as Dreamweaver (or the open source Nvu program based on Mozilla project code) and HTML Fill will still work perfectly, whereas these tools are not designed to visually display fields generated in templates with the helper functions. The decision as to whether you should use the field helpers or code HTML fields directly will depend largely on whether you want to use such tools.</p>
</div>
<p id="index-3052">If you run the example, you will see that the result is very similar to what was generated when you handled the form manually earlier in the chapter. The HTML generated for the error messages is slightly different, though. It includes some comments added by HTML Fill.</p>
<p>This is the generated HTML:</p>
<div class="highlight-python"><pre>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;FormDemo&lt;/title&gt;
&lt;link rel="stylesheet" type="text/css"
    href="/style/style.css" /&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;h1&gt;Enter Your E-mail Address&lt;/h1&gt;

&lt;form action="/formtest/submit" method="get"&gt;
&lt;p&gt;E-mail Address: &lt;!-- for: email --&gt;
&lt;span class="error-message"&gt;An email address must contain a single @&lt;/span&gt;&lt;br /&gt;
&lt;input name="email" type="text" class="error" value="test_example.com" /&gt;&lt;/p&gt;

&lt;p&gt;Date:           &lt;!-- for: date --&gt;
&lt;span class="error-message"&gt;That month only has 31 days&lt;/span&gt;&lt;br /&gt;
&lt;input name="date" type="text" class="error" value="1/40/2008" /&gt;&lt;/p&gt;
&lt;p&gt;                &lt;input name="submit" type="submit" value="Submit" /&gt;&lt;/p&gt;
&lt;/form&gt;
&lt;/form&gt;


&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<div class="section" id="error-message-formatting">
<h3>Error Message Formatting<a class="headerlink" href="#error-message-formatting" title="Permalink to this headline">Â¶</a></h3>
<p id="index-3053">The error message formatting might not be quite what you were after, so HTML Fill defines two special tags that can be used to customize how the error messages are displayed:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">&lt;form:error</span> <span class="pre">name=&quot;field_name&quot;</span> <span class="pre">format=&quot;formatter&quot;&gt;</span></tt>:</dt>
<dd>This tag is eliminated completely if there is no error for the named field. Otherwise, the error is passed through the given formatter (<tt class="docutils literal"><span class="pre">default()</span></tt> if no <tt class="docutils literal"><span class="pre">format</span></tt> attribute is given).</dd>
<dt><tt class="docutils literal"><span class="pre">&lt;form:iferror</span> <span class="pre">name=&quot;field_name&quot;&gt;...&lt;/form:iferror&gt;</span></tt>:</dt>
<dd>If the named field doesnâ€™t have an error, everything between the tags will be eliminated. Use <tt class="docutils literal"><span class="pre">name=&quot;not</span> <span class="pre">field_name&quot;</span></tt> to invert the behavior (in other words, include text only if there are no errors for the field).</dd>
</dl>
<p id="index-3054">Formatters are functions that take the error text as a single argument and return a string that is inserted into the template. Formatters are specified as arguments to the <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt> function, which I will describe next. The default formatter returns the following:</p>
<div class="highlight-python"><pre>&lt;span class="error-message"&gt;(message)&lt;/span&gt;&lt;br&gt;</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">(message)</span></tt> is replaced with the error message concerned. Most of the time it is best to use a formatter because the second form displays the static HTML youâ€™ve specified, not the actual error message generated.</p>
<p>If any errors are generated for fields that donâ€™t exist, they are added at the top of the form.</p>
</div>
<div class="section" id="render-arguments">
<h3>Render Arguments<a class="headerlink" href="#render-arguments" title="Permalink to this headline">Â¶</a></h3>
<p id="index-3055">HTML Fillâ€™s <tt class="docutils literal"><span class="pre">render()</span></tt> function has the following arguments that you can use to customize how the form is rendered:</p>
<div class="highlight-python"><pre>def render(form, defaults=None, errors=None, use_all_keys=False,
       error_formatters=None, add_attributes=None,
       auto_insert_errors=True, auto_error_formatter=None,
       text_as_default=False, listener=None)</pre>
</div>
<p>It is important to note that HTML Fillâ€™s <tt class="docutils literal"><span class="pre">render()</span></tt> function has nothing to do with the <tt class="docutils literal"><span class="pre">render()</span></tt> function youâ€™ve been using to render templates; it is just unfortunate that both have the same name.</p>
<p>The example so far has used the <tt class="docutils literal"><span class="pre">form</span></tt>, <tt class="docutils literal"><span class="pre">defaults</span></tt> and <tt class="docutils literal"><span class="pre">errors</span></tt> arguments, but other options can be useful too:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">use_all_keys</span></tt></dt>
<dd>If this is <tt class="xref docutils literal"><span class="pre">True</span></tt>, if there are any extra fields from defaults or errors that couldnâ€™t be used in the form, it will be an error.</dd>
<dt><tt class="docutils literal"><span class="pre">error_formatters</span></tt></dt>
<dd>This is a dictionary of formatter names to one-argument functions that format an error into HTML. Some default formatters are provided if you donâ€™t provide this.</dd>
<dt><tt class="docutils literal"><span class="pre">add_attributes</span></tt></dt>
<dd>This is a dictionary of field names to a dictionary of attribute name/values. If the name starts with <tt class="docutils literal"><span class="pre">+</span></tt>, then the value will be appended to any existing attribute (for example, <tt class="docutils literal"><span class="pre">{'+class':</span> <span class="pre">'</span> <span class="pre">important'}</span></tt>).</dd>
<dt><tt class="docutils literal"><span class="pre">auto_insert_errors</span></tt></dt>
<dd>If this is <tt class="xref docutils literal"><span class="pre">True</span></tt> (the default), then any errors for which <tt class="docutils literal"><span class="pre">&lt;form:error&gt;</span></tt> tags canâ€™t be found will be put just above the associated input field, or at the top of the form if no field can be found.</dd>
<dt><tt class="docutils literal"><span class="pre">auto_error_formatter</span></tt></dt>
<dd>This is used to create the HTML that goes above the fields. By default, it wraps the error message in a span and adds a <tt class="docutils literal"><span class="pre">&lt;br&gt;</span></tt>.</dd>
<dt><tt class="docutils literal"><span class="pre">text_as_default</span></tt></dt>
<dd>If this is <tt class="xref docutils literal"><span class="pre">True</span></tt> (the default is <tt class="xref docutils literal"><span class="pre">False</span></tt>), then <tt class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=unknown&gt;</span></tt> will be treated as text inputs.</dd>
</dl>
<dl class="docutils" id="index-3056">
<dt><tt class="docutils literal"><span class="pre">listener</span></tt></dt>
<dd>This can be an object that watches fields pass; the only one currently is in <tt class="docutils literal"><span class="pre">formencode.htmlfill_schemabuilder.SchemaBuilder</span></tt>.</dd>
</dl>
</div>
</div>
<div class="section" id="doing-validation-the-quick-way">
<h2>Doing Validation the Quick Way<a class="headerlink" href="#doing-validation-the-quick-way" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3057">Now that youâ€™ve seen in detail how to use FormEncode and HTML Fill, youâ€™ll be pleased to know that Pylons provides an even simpler way of using the same functionality that is suitable for the majority of use cases you are likely to encounter.</p>
<p>You can use it like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/simpleform.html&#39;</span><span class="p">)</span>

<span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">EmailForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="n">post_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">on_get</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;Your email is: </span><span class="si">%s</span><span class="s"> and the date selected was </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">],</span>
    <span class="p">)</span>
</pre></div>
</div>
<p id="index-3058">Youâ€™ll need to import the <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator at the top of the controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pylons.decorators</span> <span class="kn">import</span> <span class="n">validate</span>
</pre></div>
</div>
<p>What this says is that if the data submitted to the <tt class="docutils literal"><span class="pre">submit()</span></tt> action contains any errors, then the request should be rerun as a GET request to the <tt class="docutils literal"><span class="pre">form()</span></tt> action. The result of calling the <tt class="docutils literal"><span class="pre">form()</span></tt> action is then passed through HTML Fill to render the errors and repopulate the form with the values that were submitted.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Python 2.3 doesnâ€™t support decorators, so rather than using the <tt class="docutils literal"><span class="pre">&#64;validate()</span></tt> syntax, you need to put <tt class="docutils literal"><span class="pre">email</span> <span class="pre">=</span> <span class="pre">validate(schema=EmailForm(),</span> <span class="pre">form='form',</span> <span class="pre">post_only=False,</span> <span class="pre">on_get=True)(email)</span></tt> after the e-mail functionâ€™s declaration.</p>
</div>
<p id="index-3059">By default, if you donâ€™t specify <tt class="docutils literal"><span class="pre">post_only=False</span></tt> and <tt class="docutils literal"><span class="pre">on_get=True</span></tt> to the <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator, validation would occur only on POST requests, so you would need to alter your form definition so that the method is a POST:</p>
<div class="highlight-python"><pre>&lt;% h.form(h.url_for(action='submit'), method='post') %&gt;</pre>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">If you do this, calling an action wrapped by <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> using a GET request will bypass the validation and call the action anyway. You need to make sure this doesnâ€™t pose a security risk in your application. You could prevent this by testing whether a GET or a POST is being used in the body of the action. The request method can be determined using <tt class="docutils literal"><span class="pre">request.method</span></tt>.</p>
</div>
<p id="index-3060">You can customize the way HTML Fill is called by passing any of the arguments accepted by <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt> as keyword arguments to <tt class="docutils literal"><span class="pre">validate()</span></tt>. For example, to specify a custom error formatter, you can do this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">htmlfill</span>

<span class="k">def</span> <span class="nf">custom_formatter</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;&lt;span class=&quot;custom-message&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/span&gt;&lt;br /&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">htmlfill</span><span class="o">.</span><span class="n">html_quote</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Update the <tt class="docutils literal"><span class="pre">submit()</span></tt> action to look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@validate</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">EmailForm</span><span class="p">(),</span> <span class="n">form</span><span class="o">=</span><span class="s">&#39;form&#39;</span><span class="p">,</span> <span class="n">post_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">on_get</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">auto_error_formatter</span><span class="o">=</span><span class="n">custom_formatter</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;Your email is: </span><span class="si">%s</span><span class="s"> and the date selected was </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">],</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_result</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">],</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>With this in place, the error messages will be wrapped in <tt class="docutils literal"><span class="pre">&lt;span</span> <span class="pre">class=&quot;custom-message&quot;&gt;</span></tt> tags. If you run the example, you will notice that the error messages are no longer highlighted in red because there is no style set up for the new error class.</p>
<p>You can pass other options to the HTML Fill <tt class="docutils literal"><span class="pre">render()</span></tt> function in the same way via the <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator.</p>
<p id="index-3061">The <tt class="docutils literal"><span class="pre">&#64;validate</span></tt> decorator is documented at <a class="reference external" href="javascript:if(confirm('http://docs.pylonshq.com/modules/decorators  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://docs.pylonshq.com/modules/decorators#module-pylons.decorators'" tppabs="http://docs.pylonshq.com/modules/decorators#module-pylons.decorators">http://docs.pylonshq.com/modules/decorators#module-pylons.decorators</a>.</p>
</div>
<div class="section" id="using-custom-validators">
<h2>Using Custom Validators<a class="headerlink" href="#using-custom-validators" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3062">FormEncode comes with a useful set of validators, but you can also easily create your own. One common reason for wanting to do this is if you are populating a select field with values from a database and you want to ensure the value submitted is one of the values in the database.</p>
<p>For this example, imagine you have a function called <tt class="docutils literal"><span class="pre">get_option_values()</span></tt> that interacts with a database every time it is called and returns a list of valid integers.</p>
<p>Hereâ€™s a potential implementation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidOption</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">validate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">valid_values</span> <span class="o">=</span> <span class="n">get_option_values</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;Invalid value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>When the validator is used in a schema and checked, an error message will be displayed if the value submitted isnâ€™t one of the options returned by <tt class="docutils literal"><span class="pre">get_option_values()</span></tt>.</p>
<p>You might use it like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EmailForm</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">DateConverter</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">option</span> <span class="o">=</span> <span class="n">ValidOption</span><span class="p">()</span>
</pre></div>
</div>
<p id="index-3063">Letâ€™s have a look at the implementation in more detail. Notice that the <tt class="docutils literal"><span class="pre">validate_python()</span></tt> method also takes a <tt class="docutils literal"><span class="pre">state</span></tt> argument. Itâ€™s used for very little in the validation system but provides a mechanism for passing information from Pylons to any custom validators you write. The <tt class="docutils literal"><span class="pre">c</span></tt> global is used in Pylons for storing per-request state information, so it makes sense to also use it as the state argument to your validators, although you are free to use other objects if you prefer.</p>
<p id="index-3064">As an example, letâ€™s imagine that <tt class="docutils literal"><span class="pre">get_option_values()</span></tt> relied on a database connection that was set up on each request. You couldnâ€™t pass the connection as an argument to <tt class="docutils literal"><span class="pre">ValidOption</span></tt> because the connection wouldnâ€™t exist at the point Python created the schema. The connection exists only during the request, so you would attach it to the <tt class="docutils literal"><span class="pre">c</span></tt> global during the request and pass the <tt class="docutils literal"><span class="pre">c</span></tt> global as the <tt class="docutils literal"><span class="pre">state</span></tt> argument when instantiating the schema. Hereâ€™s how the start of the <tt class="docutils literal"><span class="pre">submit()</span></tt> action might look from the full FormEncode and HTML Fill example earlier:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Imagine we have a connection object now:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">EmailForm</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="o">...</span> <span class="n">same</span> <span class="k">as</span> <span class="n">before</span>
</pre></div>
</div>
<p>You could now update the example like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidOption</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">validate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">valid_values</span> <span class="o">=</span> <span class="n">get_option_values</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;Invalid value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>In this way, the validator can use request-specific information even though it is defined before the request starts.</p>
<p id="index-3065">The previous implementation uses the <tt class="docutils literal"><span class="pre">validate_python()</span></tt> method, which simply raises an exception if it needs to do so. This is useful in this example because the conversion needs to be done by the validator when converting to and from Python. This wonâ€™t be the case for all the validators you create, though. The <tt class="docutils literal"><span class="pre">_to_python()</span></tt> and <tt class="docutils literal"><span class="pre">_from_python()</span></tt> methods are provided for you to implement any conversion code to convert to or from Python, respectively.</p>
<p>The <tt class="docutils literal"><span class="pre">validate_python()</span></tt> method is called <em>after</em> <tt class="docutils literal"><span class="pre">_to_python()</span></tt> so that the <tt class="docutils literal"><span class="pre">value</span></tt> argument will be a normal Python object by the time it comes to being validated. <tt class="docutils literal"><span class="pre">validate_python()</span></tt> is called <em>before</em> <tt class="docutils literal"><span class="pre">_from_python()</span></tt>. Both <tt class="docutils literal"><span class="pre">_to_python()</span></tt> and <tt class="docutils literal"><span class="pre">_from_python()</span></tt> take the same arguments as <tt class="docutils literal"><span class="pre">validate_python()</span></tt>.</p>
<p id="index-3066">Youâ€™ll remember from earlier in the chapter that validators  can be customized when you instantiate them in a schema. At the moment, the validator youâ€™ve created always displays the message <tt class="docutils literal"><span class="pre">Invalid</span> <span class="pre">value</span></tt>. Letâ€™s update the validator to allow it to be customized:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidOption</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;invalid&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid value&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">valid_values</span> <span class="o">=</span> <span class="n">get_option_values</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s">&quot;invalid&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="n">c</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>You can also include values in the message itself like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ValidOption</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">FancyValidator</span><span class="p">):</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;invalid&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid value </span><span class="si">%(invalid)s</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">valid_values</span> <span class="o">=</span> <span class="n">get_option_values</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s">&quot;invalid&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="n">value</span><span class="p">),</span>
                <span class="n">value</span><span class="p">,</span>
                <span class="n">c</span>
            <span class="p">)</span>
</pre></div>
</div>
<p id="index-3067">The message string specified gets interpolated with a dictionary made from the keyword arguments you pass to the <tt class="docutils literal"><span class="pre">self.message()</span></tt> function. This system is designed to make the messages easy to format for different environments or replaceable for different languages.</p>
<p id="index-3068">Youâ€™ll also notice that you use a special exception class, <tt class="docutils literal"><span class="pre">formencode.Invalid</span></tt>, to raise an error. This is the same exception class you catch in the controller action and use to obtain the values to pass to <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt>. Besides the string error message, <tt class="docutils literal"><span class="pre">Invalid</span></tt> exceptions have a few other instance variables:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">value</span></tt></dt>
<dd>This is the input to the validator that failed.</dd>
<dt><tt class="docutils literal"><span class="pre">state</span></tt></dt>
<dd>This is the associated state.</dd>
<dt><tt class="docutils literal"><span class="pre">msg</span></tt></dt>
<dd>This is the error message (<tt class="docutils literal"><span class="pre">str(error)</span></tt> returns this).</dd>
<dt><tt class="docutils literal"><span class="pre">error_list</span></tt></dt>
<dd>If the exception happened in a <tt class="docutils literal"><span class="pre">ForEach</span></tt> (list) validator, then this will contain a list of <tt class="docutils literal"><span class="pre">Invalid</span></tt> exceptions. Each item from the list will have an entry, either <tt class="xref docutils literal"><span class="pre">None</span></tt> for no error or an exception.</dd>
<dt><tt class="docutils literal"><span class="pre">error_dict</span></tt></dt>
<dd>If the exception happened in a <tt class="docutils literal"><span class="pre">Schema</span></tt> (dictionary) validator, then this will contain <tt class="docutils literal"><span class="pre">Invalid</span></tt> exceptions for each failing field.</dd>
<dt><tt class="docutils literal"><span class="pre">.unpack_errors()</span></tt></dt>
<dd>This method returns a set of lists and dictionaries containing strings for each error. Itâ€™s an unpacking of <tt class="docutils literal"><span class="pre">error_list</span></tt>, <tt class="docutils literal"><span class="pre">error_dict</span></tt>, and <tt class="docutils literal"><span class="pre">msg</span></tt>. If you get an <tt class="docutils literal"><span class="pre">Invalid</span></tt> exception from a <tt class="docutils literal"><span class="pre">Schema</span></tt>, you probably want to call this method on the exception object.</dd>
</dl>
<p id="index-3069">If you are interested in writing your own validators, it is useful to see the source code for the <tt class="docutils literal"><span class="pre">FancyValidator</span></tt> class. It is in the <tt class="docutils literal"><span class="pre">formencode.api</span></tt> module and explains all the options and methods validators have. There are other types of validators too such as compound validators and chained validators. Generally speaking, the best way to implement your own validator is to look at the source code of an existing validator that behaves in a similar manner and implement your own validator in the same way.</p>
</div>
<div class="section" id="solving-the-repeating-fields-problem">
<h2>Solving the Repeating Fields Problem<a class="headerlink" href="#solving-the-repeating-fields-problem" title="Permalink to this headline">Â¶</a></h2>
<p id="index-3070">In real-world examples, you rarely just need a form that can be populated from a flat dictionary structure. Forms that contain subforms or repeating sets of fields are actually very common.</p>
<p>Letâ€™s imagine a situation where you are writing a form to allow a researcher to add information about a research project they are conducting. They might need to provide the following information:</p>
<blockquote>
<ul class="simple">
<li>The title of the study</li>
<li>When it is going to start and end</li>
<li>The contact details of the people who are participating</li>
</ul>
</blockquote>
<p>Contact details consist of the following information:</p>
<blockquote>
<ul class="simple">
<li>Title</li>
<li>First name</li>
<li>Surname</li>
<li>Role in the project</li>
</ul>
</blockquote>
<p>Letâ€™s also imagine that a research project requires at least one person to be added and also that there can be only one person with the role of chief investigator.</p>
<p>You can easily provide a form to enter the study title, start date, and end date, but providing a form to allow an unknown number of peopleâ€™s contact details to be entered is slightly trickier. You can take one of two approaches:</p>
<blockquote>
<ul class="simple">
<li>Design the form in a wizard format. The user enters the title, start date, and end date on the first screen and clicks Submit. The data is saved, and the second screen is displayed, allowing the user to add the contact details of the first person. Once they have submitted the form, they are asked whether they want to add another person. This continues until they have added all the necessary data.</li>
<li>Display a single form containing the title, start date, and end date as before but with a button to allow the user to add fields to add a person. When the user clicks the Add New Person button, a set of fields to enter the first person are shown. The user can submit the form or click the Add New Person button again to add another set of fields. Finally, once they have completed the whole form containing the study and person data, they click Save, and the data is validated and saved in one go.</li>
</ul>
</blockquote>
<p id="index-3071">The advantage of the first approach is that at any one time you are dealing with only one set of fields that can be submitted as simple name/value pairs, so the data structure is very straightforward. The disadvantage is that at each step in the wizard you need to store the data that has already been submitted, and this has its own problems. Imagine, for example, you save the study information in the first step but the user changes their mind and never completes the second step of adding a person. One of the requirements was that studies should have at least one person associated with them, but now you have saved a study that doesnâ€™t have any people. Say, instead, that the user does add a person and gives them a role of chief investigator. Now letâ€™s imagine they add another person and give them a role of chief investigator too. You canâ€™t have more than one chief investigator, so the validation code will display an error explaining the problem. Imagine, though, that the user really does want the second person to be the chief investigator and made a mistake in giving the first person the chief investigator role. The user has no choice but to start the form again.</p>
<p>Obviously, all the problems with the wizard approach can be solved. You can store the data in a temporary location or a session store and save it properly only at the end of the wizard, or you can provide Back buttons so the user can go back through the wizard and make changes, but it can be a surprising amount of work to program the logic and validation code for this sort of workflow.</p>
<p id="index-3072">The major advantage of the second approach is that all the required data is stored client-side throughout the submission and validation cycles, which means your Pylons controller needs to store the data only once, after all the input has been validated. This can greatly reduce the complexity of your controller logic. FormEncode provides the necessary tools to help you with this.</p>
<div class="section" id="creating-the-form">
<h3>Creating the Form<a class="headerlink" href="#creating-the-form" title="Permalink to this headline">Â¶</a></h3>
<p id="index-3073">The first thing you need to do is define the schema. Hereâ€™s what the main study schema might look like:</p>
<div class="highlight-python"><pre>class Study(Schema)
    title = String(not_empty=True)
    start_date = DateConverter()
    end_date = DateConverter()
    people = ForEach(Person())</pre>
</div>
<p id="index-3074">As you can see, the schema has <tt class="docutils literal"><span class="pre">title</span></tt>, <tt class="docutils literal"><span class="pre">start_date</span></tt>, and <tt class="docutils literal"><span class="pre">end_date</span></tt> fields, which use ordinary validators as you would expect, but there is also a <tt class="docutils literal"><span class="pre">people</span></tt> field that takes a <tt class="docutils literal"><span class="pre">ForEach()</span></tt> validator. The <tt class="docutils literal"><span class="pre">ForEach()</span></tt> validator takes a single argument, which is another validator or schema it should validate. In this case, you want it to validate people, so youâ€™ve specified an instance of a <tt class="docutils literal"><span class="pre">Person</span></tt> schema. The <tt class="docutils literal"><span class="pre">Person</span></tt> schema looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">surname</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">OneOf</span><span class="p">([</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;3&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p id="index-3075">The <tt class="docutils literal"><span class="pre">role</span></tt> field will be a select drop-down that takes the values in Table 6-2.</p>
<table border="1" class="docutils">
<colgroup>
<col width="74%" />
<col width="26%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Name</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Chief investigator</td>
<td>1</td>
</tr>
<tr><td>Assistant</td>
<td>2</td>
</tr>
<tr><td>Student</td>
<td>3</td>
</tr>
</tbody>
</table>
<p>Table 6-2. Possible Values for Role</p>
<p id="index-3076">The <tt class="docutils literal"><span class="pre">OneOf</span></tt> validator checks that the value submitted for the <tt class="docutils literal"><span class="pre">role</span></tt> is one of the values specified.</p>
<p id="index-3077">Now turn your attention to the template defs to produce the fields. Youâ€™ll create a working example as you go through this chapter, so letâ€™s create a project for it (accept the default values when prompted):</p>
<div class="highlight-python"><pre>$ paster create --template=pylons FormExample
$ cd FormExample
$ paster controller study</pre>
</div>
<p>Create two directories named <tt class="docutils literal"><span class="pre">base</span></tt> and <tt class="docutils literal"><span class="pre">derived</span></tt> in the <tt class="docutils literal"><span class="pre">templates</span></tt> directory, and add a <tt class="docutils literal"><span class="pre">base/index.html</span></tt> file that looks like this:</p>
<div class="highlight-python"><pre>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;FormsExample&lt;/title&gt;
&lt;style type="text/css"&gt;
span.error-message{
    font-weight: bold;
    color: #c00;
}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
${next.body()}
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<p id="index-3078">Then create a new template called <tt class="docutils literal"><span class="pre">derived/form.html</span></tt> with the following content:</p>
<div class="highlight-python"><pre>&lt;%inherit file="/base/index.html" /&gt;

&lt;%def name="study()"&gt;
    &lt;fieldset&gt;&lt;legend&gt;Study&lt;/legend&gt;

        &lt;label for="title"&gt;Title&lt;/label&gt;&lt;br /&gt;
        ${h.text(name="title", id="title")}&lt;br /&gt;

        &lt;label for="start_date"&gt;Start Date&lt;/label&gt;&lt;br /&gt;
        ${h.text(name="start_date", id="startdate")}&lt;br /&gt;

        &lt;label for="end_date"&gt;End Date&lt;/label&gt;&lt;br /&gt;
        ${h.text(name="end_date", id="enddate")}&lt;br /&gt;
    &lt;/fieldset&gt;&lt;br /&gt;
        % for id in range(c.number_of_people):
            ${person(id=id)}
        % endfor
&lt;/%def&gt;

&lt;%def name="person(id)"&gt;
    &lt;fieldset&gt;&lt;legend&gt;Person&lt;/legend&gt;

        &lt;label for="person-${id}.title"&gt;Title&lt;/label&gt;&lt;br /&gt;
        ${h.text(name="person-%s.title"%(id), id="person-%s.title"%(id))}&lt;br /&gt;

        &lt;label for="person-${id}.firstname"&gt;First Name&lt;/label&gt;&lt;br /&gt;
        ${h.text(
            name="person-%s.firstname"%(id),
            id="person-%s.firstname"%(id
        ))}&lt;br /&gt;

        &lt;label for="person-${id}.surname"&gt;Surname&lt;/label&gt;&lt;br /&gt;
        ${h.text(name="person-%s.surname"%(id), id="person-%s.surname"%(id))}&lt;br /&gt;

        &lt;label for="person-${id}.role"&gt;Role&lt;/label&gt;&lt;br /&gt;
        ${h.select(
            "person-%s.role"%(id),
            [],
            [
                ['1', 'Chief Investigator'],
                ['2', 'Assistant'],
                ['3', 'Student'],
            ],
            id="person-%s.role"%(id),
        )}&lt;br /&gt;

        ${h.submit(name="action", value="Remove %s"%(id))}

    &lt;/fieldset&gt;&lt;br /&gt;
&lt;/%def&gt;

&lt;h1&gt;Create a Study&lt;/h1&gt;

${h.form(h.url_for(controller='study', action='process'))}
${study()}
${h.submit(name="action", value="Save")}
${h.submit(name="action", value="Add New Person")}
${h.end_form()}</pre>
</div>
<p id="index-3079">Rendering this template would result in the <tt class="docutils literal"><span class="pre">study()</span></tt> def being called, and this in turn would call the <tt class="docutils literal"><span class="pre">person()</span></tt> def to create a set of fields for the number of people specified in <tt class="docutils literal"><span class="pre">c.number_of_people</span></tt>, which you will set in the controller in a minute.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The template youâ€™ve created uses <tt class="docutils literal"><span class="pre">&lt;fieldset&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;label&gt;</span></tt> HTML tags to create the form rather than creating a layout with tables or other HTML structures. This is considered best practice because the <tt class="docutils literal"><span class="pre">for</span></tt> attributes of the <tt class="docutils literal"><span class="pre">&lt;label&gt;</span></tt> tags clearly associate the text of the label with the field itself so that people who use screen readers will still be able to fill in your form. Using this technique also makes your forms much easier to style using CSS.</p>
</div>
<p id="index-3080">The <tt class="docutils literal"><span class="pre">Study</span></tt> schema expects nested data structures, but HTML forms produce flat structures with keys (field names) and their associated values. To solve this problem, FormEncode provides a <tt class="docutils literal"><span class="pre">NestedVariables</span></tt> class in the <tt class="docutils literal"><span class="pre">nestedvariables</span></tt>  module that provides a way of converting nested data structures to and from a flat set of field names. To do this, it uses keys with <tt class="docutils literal"><span class="pre">&quot;.&quot;</span></tt> for nested dictionaries and <tt class="docutils literal"><span class="pre">&quot;-int&quot;</span></tt> for (ordered) lists. A structure like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&#39;people&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">&#39;fname&#39;</span><span class="p">:</span> <span class="s">&quot;John&quot;</span><span class="p">,</span> <span class="s">&#39;lname&#39;</span><span class="p">:</span> <span class="s">&quot;Doe&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&#39;fname&#39;</span><span class="p">:</span> <span class="s">&quot;Jane&quot;</span><span class="p">,</span> <span class="s">&#39;lname&#39;</span><span class="p">:</span> <span class="s">&#39;Brown&#39;</span><span class="p">},</span>
        <span class="s">&quot;Tim Smith&quot;</span>
    <span class="p">],</span>
    <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="bp">None</span><span class="p">:</span> <span class="s">&quot;save&quot;</span><span class="p">,</span>
        <span class="s">&#39;option&#39;</span><span class="p">:</span> <span class="s">&quot;overwrite&quot;</span><span class="p">,</span>
        <span class="s">&#39;confirm&#39;</span><span class="p">:</span> <span class="s">&quot;yes&quot;</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="index-3081">can therefore be mapped to form fields with the names and values in Table 6-3.</p>
<table border="1" class="docutils">
<colgroup>
<col width="57%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Names</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal"><span class="pre">people-0.fname</span></tt></td>
<td><tt class="docutils literal"><span class="pre">John</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">people-0.lname</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Doe</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">people-1.fname</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Jane</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">people-1.lname</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Brown</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">people-2</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Tim</span> <span class="pre">Smith</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">action</span></tt></td>
<td><tt class="docutils literal"><span class="pre">save</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">action.option</span></tt></td>
<td><tt class="docutils literal"><span class="pre">overwrite</span></tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">action.confirm</span></tt></td>
<td><tt class="docutils literal"><span class="pre">yes</span></tt></td>
</tr>
</tbody>
</table>
<p>Table 6-3. Field Names Used in the Example and Their Corresponding Values</p>
<p>Notice how the value <tt class="docutils literal"><span class="pre">save</span></tt> is associated directly with <tt class="docutils literal"><span class="pre">action</span></tt> rather than <tt class="docutils literal"><span class="pre">action.None</span></tt>. This is so that if the dictionary contained a key <tt class="docutils literal"><span class="pre">&quot;None&quot;</span></tt> and a key <tt class="xref docutils literal"><span class="pre">None</span></tt>, they could both be handled correctly.</p>
<p>Returning to the example, notice how in the <tt class="docutils literal"><span class="pre">person</span></tt> def you just created the field names that make up each person follow this naming convention so that FormEncode can automatically convert the values submitted from the HTML form into the nested data structure the <tt class="docutils literal"><span class="pre">Study</span></tt> schema requires.</p>
<p id="index-3082">To make this conversion happen automatically, you need to add a <tt class="docutils literal"><span class="pre">NestedVariables</span></tt> prevalidator to the <tt class="docutils literal"><span class="pre">Study</span></tt> schema so it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Study</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">pre_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">NestedVariables</span><span class="p">()]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">DateConverter</span><span class="p">()</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">DateConverter</span><span class="p">()</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">ForEach</span><span class="p">(</span><span class="n">Person</span><span class="p">())</span>
</pre></div>
</div>
<p id="index-3083">Prevalidators are validators that are run on the values before the values are passed to each of the other validators for validation and conversion. Schemas also take a <tt class="docutils literal"><span class="pre">chained_validators</span></tt> attribute, which youâ€™ll see later is for performing validation on the whole form after the prevalidators and individual field validators have been run.</p>
<p>The form also includes buttons for adding new people and removing ones the user added by mistake. These fields arenâ€™t part of the schema and donâ€™t need to be included in the validated and converted output, so you can also add the attributes <tt class="docutils literal"><span class="pre">allow_extra_fields=True</span></tt> and <tt class="docutils literal"><span class="pre">filter_extra_fields=True</span></tt> to the <tt class="docutils literal"><span class="pre">Study</span></tt> schema.</p>
<p>At this stage, you can start adding content including the finished schemas to the <tt class="docutils literal"><span class="pre">study</span></tt> controller you created earlier. At the top of the file after <tt class="docutils literal"><span class="pre">log</span></tt> is set up, add the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">formencode.schema</span> <span class="kn">import</span> <span class="n">Schema</span>
<span class="kn">from</span> <span class="nn">formencode.validators</span> <span class="kn">import</span> <span class="n">Invalid</span><span class="p">,</span> <span class="n">FancyValidator</span>
<span class="kn">from</span> <span class="nn">formencode.validators</span> <span class="kn">import</span> <span class="n">Int</span><span class="p">,</span> <span class="n">DateConverter</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">OneOf</span>
<span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">variabledecode</span>
<span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">htmlfill</span>
<span class="kn">from</span> <span class="nn">formencode.foreach</span> <span class="kn">import</span> <span class="n">ForEach</span>
<span class="kn">from</span> <span class="nn">formencode.api</span> <span class="kn">import</span> <span class="n">NoDefault</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">surname</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">OneOf</span><span class="p">([</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;3&#39;</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">Study</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">pre_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">variabledecode</span><span class="o">.</span><span class="n">NestedVariables</span><span class="p">()]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">DateConverter</span><span class="p">()</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">DateConverter</span><span class="p">()</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">ForEach</span><span class="p">(</span><span class="n">Person</span><span class="p">())</span>
</pre></div>
</div>
<p id="index-3084">One of the requirements was that a study should have at least one person. The <tt class="docutils literal"><span class="pre">ForEach</span></tt> validator you are using to validate people takes the same <tt class="docutils literal"><span class="pre">not_empty</span></tt> argument that validators such as <tt class="docutils literal"><span class="pre">String</span></tt> take, so you might think that adding <tt class="docutils literal"><span class="pre">not_empty=True</span></tt> to the validator constructor would be all you had to do. Unfortunately, this isnâ€™t the case; the <tt class="docutils literal"><span class="pre">ForEach</span></tt> validator is set up to return the value <tt class="docutils literal"><span class="pre">[]</span></tt> if the field is missing, so FormEncode doesnâ€™t notice the problem. There are two ways to fix this depending on what you want to achieve:</p>
<blockquote>
<ul class="simple">
<li>Use <tt class="docutils literal"><span class="pre">not_empty=True</span></tt>, but always specify a hidden field such as <tt class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;</span> <span class="pre">name=&quot;person&quot;</span> <span class="pre">value=&quot;&quot;</span> <span class="pre">/&gt;</span></tt> so that a value is always submitted and FormEncode is forced to validate the field. When the value <tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt> is received, the <tt class="docutils literal"><span class="pre">not_empty=True</span></tt> argument means the standard <tt class="docutils literal"><span class="pre">empty</span></tt> message <tt class="docutils literal"><span class="pre">Please</span> <span class="pre">enter</span> <span class="pre">a</span> <span class="pre">value</span></tt> gets displayed and the user is aware of the problem. When people are added, the hidden field still gets submitted, but <tt class="docutils literal"><span class="pre">variabledecode</span></tt> overwrites the value with the decoded people values, so everything works as it should.</li>
<li>Use <tt class="docutils literal"><span class="pre">if_missing=NoDefault</span></tt> to tell FormEncode not to return an empty list, <tt class="docutils literal"><span class="pre">[]</span></tt>, if no people are submitted (which is the default behavior). Instead, because there is no default, the <tt class="docutils literal"><span class="pre">Study</span></tt> schema will display its <tt class="docutils literal"><span class="pre">missing</span></tt> message <tt class="docutils literal"><span class="pre">Missing</span> <span class="pre">value</span></tt>.</li>
</ul>
</blockquote>
<p id="index-3085">You can also customize the <tt class="docutils literal"><span class="pre">Missing</span> <span class="pre">value</span></tt> message using the second approach like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ForEach</span><span class="p">(</span>
    <span class="n">Person</span><span class="p">(),</span>
    <span class="n">if_missing</span><span class="o">=</span><span class="n">NoDefault</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;missing&#39;</span><span class="p">:</span><span class="s">&#39;Please add a person&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p id="index-3086">Another requirement is that there should be only one chief investigator. You can check this condition by creating a custom validator to check for the presence of the one chief investigator. You could implement this as a normal validator, but here you are going to implement it as a chained validator. Chained validators are slightly different from normal validators because they are checked only once all the individual fields have been validated. They are usually used when a validation rule depends on more than one field.</p>
<p>Ordinary validators are passed the raw unconverted value from the field they are validating. Chained validators are passed the validated and converted dictionary of data generated after all the other validators have been run.</p>
<p id="index-3087">Hereâ€™s what the validator looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">formencode.validators</span> <span class="kn">import</span> <span class="n">FancyValidator</span>

<span class="k">class</span> <span class="nc">OneChiefInvestigator</span><span class="p">(</span><span class="n">FancyValidator</span><span class="p">):</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;too_many_cis&#39;</span><span class="p">:</span><span class="s">&quot;Only one Chief Investigator is allowed, not </span><span class="si">%(number)s</span><span class="s">&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
       <span class="n">chief_investigators_found</span> <span class="o">=</span> <span class="mi">0</span>
       <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;person&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">u&#39;1&#39;</span><span class="p">:</span>
                <span class="n">chief_investigators_found</span> <span class="o">+=</span> <span class="mi">1</span>
       <span class="k">if</span> <span class="n">chief_investigators_found</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Invalid</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s">&quot;too_many_cis&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">chief_investigators_found</span><span class="p">),</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="n">c</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>Add this validator to the schema like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Study</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">chained_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">OneChiefInvestigator</span><span class="p">()]</span>
</pre></div>
</div>
<p id="index-3088">The schema and templates are now in place, so turn your attention to the controller code that will tie everything together. The first thing to notice is that the user will expect very different behavior depending on the button that is clicked. There are buttons to do the following:</p>
<blockquote>
<ul class="simple">
<li>Save the form</li>
<li>Add a new set of person fields</li>
<li>Remove a particular set of person fields</li>
</ul>
</blockquote>
<p>To rerender the form after any of these actions, you need to calculate the number of people so that the form is regenerated with the correct number of sets of person fields. Hereâ€™s a function to do that:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">number_of_people</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="n">people_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;person-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">):</span>
            <span class="n">people_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">people_count</span>
</pre></div>
</div>
<p>Youâ€™ll also need a function to render the template and fill it with the correct values and error messages:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">render_form</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">number_of_people</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">number_of_people</span> <span class="o">=</span> <span class="n">number_of_people</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/form.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">htmlfill</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
</pre></div>
</div>
<p>You can add these two functions beneath the schema definitions in your controller.</p>
<p>All the buttons have the same name, <tt class="docutils literal"><span class="pre">action</span></tt>, so the <tt class="docutils literal"><span class="pre">process()</span></tt> action youâ€™ll create can determine which button has been pressed by looking at the value of the <tt class="docutils literal"><span class="pre">action</span></tt> URL parameter.</p>
<p id="index-3089">Here is the complete code including the schemas, validators, and controller:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">pylons</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">tmpl_context</span> <span class="k">as</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">pylons.controllers.util</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">redirect_to</span>

<span class="kn">from</span> <span class="nn">formexample.lib.base</span> <span class="kn">import</span> <span class="n">BaseController</span><span class="p">,</span> <span class="n">render</span>
<span class="c">#from formexample import model</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">formencode.schema</span> <span class="kn">import</span> <span class="n">Schema</span>
<span class="kn">from</span> <span class="nn">formencode.validators</span> <span class="kn">import</span> <span class="n">Invalid</span><span class="p">,</span> <span class="n">FancyValidator</span>
<span class="kn">from</span> <span class="nn">formencode.validators</span> <span class="kn">import</span> <span class="n">Int</span><span class="p">,</span> <span class="n">DateConverter</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">OneOf</span>
<span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">variabledecode</span>
<span class="kn">from</span> <span class="nn">formencode</span> <span class="kn">import</span> <span class="n">htmlfill</span>
<span class="kn">from</span> <span class="nn">formencode.foreach</span> <span class="kn">import</span> <span class="n">ForEach</span>
<span class="kn">from</span> <span class="nn">formencode.api</span> <span class="kn">import</span> <span class="n">NoDefault</span>

<span class="k">class</span> <span class="nc">OneChiefInvestigator</span><span class="p">(</span><span class="n">FancyValidator</span><span class="p">):</span>

    <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;too_many_cis&#39;</span><span class="p">:</span><span class="s">&quot;Only one Chief Investigator is allowed, not </span><span class="si">%(number)s</span><span class="s">&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">validate_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
       <span class="n">chief_investigators_found</span> <span class="o">=</span> <span class="mi">0</span>
       <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;person&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">person</span><span class="p">[</span><span class="s">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">u&#39;1&#39;</span><span class="p">:</span>
                <span class="n">chief_investigators_found</span> <span class="o">+=</span> <span class="mi">1</span>
       <span class="k">if</span> <span class="n">chief_investigators_found</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Invalid</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s">&quot;too_many_cis&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>  <span class="n">number</span><span class="o">=</span><span class="n">chief_investigators_found</span><span class="p">),</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="n">c</span>
            <span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
    <span class="n">firstname</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">surname</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">OneOf</span><span class="p">([</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;3&#39;</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">Study</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="n">allow_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">filter_extra_fields</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">pre_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">variabledecode</span><span class="o">.</span><span class="n">NestedVariables</span><span class="p">()]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">DateConverter</span><span class="p">()</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">DateConverter</span><span class="p">()</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">ForEach</span><span class="p">(</span>
        <span class="n">Person</span><span class="p">(),</span>
        <span class="n">if_missing</span><span class="o">=</span><span class="n">NoDefault</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;missing&#39;</span><span class="p">:</span><span class="s">&#39;Please add a person&#39;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">chained_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">OneChiefInvestigator</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">render_form</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">number_of_people</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">number_of_people</span> <span class="o">=</span> <span class="n">number_of_people</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="s">&#39;/derived/form.html&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">htmlfill</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">number_of_people</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="n">people_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;person-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">):</span>
            <span class="n">people_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">people_count</span>

<span class="k">class</span> <span class="nc">StudyController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_form</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getone</span><span class="p">(</span><span class="s">&#39;action&#39;</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="c"># Don&#39;t use the values field for repopulation</span>
        <span class="k">del</span> <span class="n">values</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#39;Add New Person&#39;</span><span class="p">:</span>
            <span class="c"># Render the form with one extra set of person fields</span>
            <span class="k">return</span> <span class="n">render_form</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
                <span class="n">number_of_people</span> <span class="o">=</span> <span class="n">number_of_people</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Remove&#39;</span><span class="p">):</span>
            <span class="c"># Get the ID of the set of person fields to remove</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c"># Create a new set of values without those fields</span>
            <span class="n">new_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;person-&#39;</span><span class="p">):</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">cur_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;person&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="n">cur_id</span><span class="o">&lt;</span><span class="nb">id</span><span class="p">:</span>
                        <span class="n">new_values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">elif</span> <span class="n">cur_id</span><span class="o">&gt;</span><span class="nb">id</span><span class="p">:</span>
                        <span class="n">new_values</span><span class="p">[</span><span class="s">&#39;person-</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cur_id</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="c"># Render the form with the new values</span>
            <span class="k">return</span> <span class="n">render_form</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="n">new_values</span><span class="p">,</span>
                <span class="n">number_of_people</span> <span class="o">=</span> <span class="n">number_of_people</span><span class="p">(</span><span class="n">new_values</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">action</span><span class="o">==</span><span class="s">&#39;Save&#39;</span><span class="p">:</span>
            <span class="c"># Assume we are trying to save the form</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">Study</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Invalid</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_form</span><span class="p">(</span>
                    <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">errors</span><span class="o">=</span><span class="n">variabledecode</span><span class="o">.</span><span class="n">variable_encode</span><span class="p">(</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">unpack_errors</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{},</span>
                        <span class="n">add_repetitions</span><span class="o">=</span><span class="bp">False</span>
                    <span class="p">),</span>
                    <span class="n">number_of_people</span><span class="o">=</span><span class="n">number_of_people</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># You would save the data here before redirecting</span>
                <span class="c"># values will be a Python nested data structure</span>
                <span class="c"># which shouldn&#39;t need any further conversion.</span>

                <span class="c"># In this case we just display the result</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Invalid action </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">action</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-3090">Since this is a new project, youâ€™ll need to add some helpers to the <tt class="docutils literal"><span class="pre">lib/helpers.py</span></tt> file before this example will work. Add these lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">webhelpers.html.tags</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">routes</span> <span class="kn">import</span> <span class="n">url_for</span>
</pre></div>
</div>
<p id="index-3091">To test this example, start the development server with the <tt class="docutils literal"><span class="pre">paster</span> <span class="pre">serve</span> <span class="pre">--reload</span> <span class="pre">development.ini</span></tt> command, and visit <a class="reference external" href="javascript:if(confirm('http://localhost:5000/study/index  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://localhost:5000/study/index'" tppabs="http://localhost:5000/study/index">http://localhost:5000/study/index</a>.</p>
<p>If the Add New Person button is clicked, the form is rerendered with its submitted values and an extra set of person fields. No validation takes place at this stage, so the values redisplayed are the same as those entered.</p>
<p>If the user clicks one of the Remove Person buttons, the ID of the set of person fields to be removed is obtained from the button value, and that set of fields is manually removed from the dictionary of values that is used to repopulate the form when it is rendered.</p>
<p>If the action isnâ€™t recognized, it is assumed the user clicked the Save button. The <tt class="docutils literal"><span class="pre">Study</span></tt> schema is used to validate and convert the data. The <tt class="docutils literal"><span class="pre">NestedVariables</span></tt> prevalidator converts the flat HTML form data into a nested data structure. Each of the fields in turn is then checked against its validator. In the case of <tt class="docutils literal"><span class="pre">person</span></tt>, this means each of the sets of person fields is itself validated against the <tt class="docutils literal"><span class="pre">Person</span></tt> schema. If there are no errors, the <tt class="docutils literal"><span class="pre">OneChiefInvestigator</span></tt> chained validator is run to ensure there is only one chief investigator.</p>
<p>If any of the validation checks fail, the form errors are encoded into a flat data structure using the <tt class="docutils literal"><span class="pre">variabledecode.encode()</span></tt> function so that each of the keys associated with the errors can be understood by <tt class="docutils literal"><span class="pre">htmlfill.render()</span></tt> and redisplayed next to the fields to which they refer.</p>
<p>Finally, if all the validation checks pass, the <tt class="docutils literal"><span class="pre">schema.to_python()</span></tt> method returns the decoded, validated, and converted values ready for your program to handle the data in whichever way it sees fit. Ordinarily, this would most likely be to save the data to a database before using <tt class="docutils literal"><span class="pre">h.redirect_to()</span></tt> to redirect the user to a page confirming the data had been saved. This example simply prints a message and displays the converted data structure.</p>
<p>Figure 6-6 shows the example during validation and with only one set of person fields added.</p>
<div class="figure">
<a class="reference external image-reference" href="_images/9349f0606.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0606.png"><img alt="Figure 6-6. The repeating fields example in action" src="_images/9349f0606.png" tppabs="http://pylonsbook.com/en/1.1/_images/9349f0606.png" /></a>
<p class="caption">Figure 6-6. The repeating fields example in action</p>
</div>
<p id="index-3092">If you were to add some valid data, the result would be structured as shown here (although Iâ€™ve added some whitespace for clarity):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&#39;person&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s">&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;Gardner&#39;</span><span class="p">,</span> <span class="s">&#39;role&#39;</span><span class="p">:</span> <span class="s">u&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;firstname&#39;</span><span class="p">:</span> <span class="s">u&#39;James&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&#39;Mr&#39;</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="s">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
    <span class="s">&#39;end_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">u&#39;Cancer Trial 3449&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">Â¶</a></h2>
<p>Form handling can be a complex area, but in this chapter you learned the key principles involved in creating HTML forms, populating fields, validating complex data structures, and displaying error messages. By dealing with these processes individually, Pylons gives you the flexibility to create any sorts of forms your application needs.</p>
<p id="index-3093">In Chapter 15, youâ€™ll revisit forms and see how you can use Ajax to make certain aspects of form handling slicker.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html" tppabs="http://pylonsbook.com/en/1.1/index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">Chapter 6: Working with Forms and Validators</a><ul>
<li><a class="reference external" href="#the-basics">The Basics</a><ul>
<li><a class="reference external" href="#post-vs-get">POST vs. GET</a></li>
<li><a class="reference external" href="#the-resubmitted-data-problem">The Resubmitted Data Problem</a></li>
</ul>
</li>
<li><a class="reference external" href="#building-forms-with-helpers">Building Forms with Helpers</a></li>
<li><a class="reference external" href="#uploading-files">Uploading Files</a></li>
<li><a class="reference external" href="#handling-forms-manually">Handling Forms Manually</a></li>
<li><a class="reference external" href="#introducing-formencode">Introducing FormEncode</a><ul>
<li><a class="reference external" href="#configuring-validators">Configuring Validators</a></li>
</ul>
</li>
<li><a class="reference external" href="#using-html-fill">Using HTML Fill</a><ul>
<li><a class="reference external" href="#error-message-formatting">Error Message Formatting</a></li>
<li><a class="reference external" href="#render-arguments">Render Arguments</a></li>
</ul>
</li>
<li><a class="reference external" href="#doing-validation-the-quick-way">Doing Validation the Quick Way</a></li>
<li><a class="reference external" href="#using-custom-validators">Using Custom Validators</a></li>
<li><a class="reference external" href="#solving-the-repeating-fields-problem">Solving the Repeating Fields Problem</a><ul>
<li><a class="reference external" href="#creating-the-form">Creating the Form</a></li>
</ul>
</li>
<li><a class="reference external" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="using-view-templates.html" tppabs="http://pylonsbook.com/en/1.1/using-view-templates.html"
                                  title="previous chapter">Chapter 5: Using View Templates</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="introducing-the-model-and-sqlalchemy.html" tppabs="http://pylonsbook.com/en/1.1/introducing-the-model-and-sqlalchemy.html"
                                  title="next chapter">Chapter 7: Introducing the Model and SQLAlchemy</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/working-with-forms-and-validators.txt" tppabs="http://pylonsbook.com/en/1.1/_sources/working-with-forms-and-validators.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="http://pylonsbook.com/en/1.1/search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" tppabs="http://pylonsbook.com/en/1.1/genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="introducing-the-model-and-sqlalchemy.html" tppabs="http://pylonsbook.com/en/1.1/introducing-the-model-and-sqlalchemy.html" title="Chapter 7: Introducing the Model and SQLAlchemy"
             >next</a> |</li>
        <li class="right" >
          <a href="using-view-templates.html" tppabs="http://pylonsbook.com/en/1.1/using-view-templates.html" title="Chapter 5: Using View Templates"
             >previous</a> |</li>
        <li><a href="index.html" tppabs="http://pylonsbook.com/en/1.1/index.html">Pylons Book v1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, James Gardner.
      Created using <a href="javascript:if(confirm('http://sphinx.pocoo.org/  \n\n¸ÃÎÄ¼þÎ´±» Teleport Pro ÏÂÔØ£¬ÒòÎª ËüÎ»ÓÚÆðÊ¼µØÖ·ÒÔÉèÖÃµÄ±ß½çÒÔÍâµÄÓò»òÂ·¾¶ÖÐ¡£  \n\nÄãÏëÒª´Ó·þÎñÆ÷´ò¿ªËüÂð?'))window.location='http://sphinx.pocoo.org/'" tppabs="http://sphinx.pocoo.org/">Sphinx</a> 0.6.3.
    </div>
  </body>
</html>